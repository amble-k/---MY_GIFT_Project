// /apps/resume_product/router_runtime.js
import { loadDB } from "../../core/storage/resume_db.js";
import { deriveStatus } from "../../core/session/deriveStatus.js";
import { RouteMap } from "../../core/session/step_ids.js";

// route -> 物理页面文件（只允许定义一次）
export const PAGE_FILE = Object.freeze({
  "/resume":            "/apps/resume_product/pages/entry/index.html",
  "/resume/scenario":   "/apps/resume_product/pages/scenario/index.html",
  "/resume/fact":       "/apps/resume_product/pages/fact/index.html",
  "/resume/resume/v1":  "/apps/resume_product/pages/resume/v1/index.html",
  "/resume/target":     "/apps/resume_product/pages/target/index.html",
  "/resume/role":       "/apps/resume_product/pages/role/index.html",
  "/resume/kash":       "/apps/resume_product/pages/kash/index.html",
  "/resume/resume/v2":  "/apps/resume_product/pages/resume/v2/index.html",
  "/resume/assessment": "/apps/resume_product/pages/assessment/index.html",
  "/resume/fit":        "/apps/resume_product/pages/fit/index.html",
  "/resume/resume/v3":  "/apps/resume_product/pages/resume/v3/index.html",
  "/resume/plan":       "/apps/resume_product/pages/plan/index.html",
  "/resume/export":     "/apps/resume_product/pages/export/index.html",
  "/health":            "/apps/resume_product/pages/_health/index.html",
});

export function getRoute() {
  const h = location.hash || "#/resume";
  return h.startsWith("#") ? h.slice(1) : h;
}

function isNoGuard() {
  try {
    return new URLSearchParams(location.search).get("noguard") === "1";
  } catch {
    return false;
  }
}
 
  
/**
 * 让任何页面都能“跳到正确的物理文件 + hash”
 * - 支持外部传入 {db, st}（给 app_boot.js 用）
 * - Hub 规则：当 route 是 /resume 时，永远允许停在 Hub（不自动推进）
 * - Guard 规则：只有 st.error.code === STEP_REQUIRED 且 非 Hub 且 非 noguard 才推进到 required_step
 */
export function dispatch(ctx = {}) {
  const qs = location.search || "";
  const currentRoute = getRoute();

  const db = ctx.db || loadDB();
  const st = ctx.st || deriveStatus(db);

  const isHub = currentRoute === "/resume" || currentRoute === "/health";
  const noGuard = isNoGuard();

  let targetRoute = currentRoute;

  const shouldGuard =
    !noGuard &&
    !isHub &&
    st?.error?.code === "STEP_REQUIRED" &&
    st?.required_step &&
    RouteMap?.[st.required_step];

  if (shouldGuard) {
    targetRoute = RouteMap[st.required_step];
  }

  const pageFile = PAGE_FILE[targetRoute] || PAGE_FILE["/resume"];
  const desiredUrl = pageFile + qs + "#" + targetRoute;

  const needMoveFile = location.pathname !== pageFile;
  const needFixHash = location.hash !== "#" + targetRoute;

  if (needMoveFile) {
    location.replace(desiredUrl);
    return { redirected: true, desiredUrl, targetRoute, pageFile };
  }

  if (needFixHash) {
    location.hash = "#" + targetRoute;
    return { redirected: false, desiredUrl, targetRoute, pageFile, hashFixed: true };
  }

  return { redirected: false, desiredUrl, targetRoute, pageFile };
}