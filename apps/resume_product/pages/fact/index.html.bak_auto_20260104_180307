<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Resume Product - Fact</title>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import { bootStepPage } from "/apps/resume_product/pages/_step_page.js?v=3";
    import { loadDB, setActive } from "/core/storage/resume_db.js";
    import { mountStepForm } from "/core/ui/step_form_v0_2.js?v=2";
  import { FACT_SPEC_V0_2, validateFactData_v0_2 } from "./fact_template.v0_2.js";

    // 通用壳（按钮会读 window.__STEP_PAYLOAD__；fact 也兼容 window.__FACT_PAYLOAD__）
    bootStepPage({ title:"Resume Product — Fact", stepId:"fact", writeFnName:"writeFactProfileDummy" });

    // v0.2 统一表单 + 回填 + payload 同步 + 自动保存
 mountStepForm({
  appId: "app",
  title: "事实信息（最小版）",
  desc: "说明：输入后将自动保存（不跳页）。进入下一步仍可用上方“写入/保存并进入下一步”。",

  // ✅ UI字段（保持你现在页面看到的那一套：姓名/目标岗位/城市/电话/邮箱/个人简介/技能/学校/专业/学历/公司/职位/时间/项目名/项目描述）
  fields: [
    { id: "fp_name",    label: "姓名",       type: "input",    placeholder: "如：王小明" },
    { id: "fp_target",  label: "目标岗位位", type: "input",    placeholder: "如：后端工程师/产品经理" },
    { id: "fp_city",    label: "城市",       type: "input",    placeholder: "如：上海" },
    { id: "fp_phone",   label: "电话",       type: "input",    placeholder: "如：138xxxx" },
    { id: "fp_email",   label: "邮箱",       type: "input",    placeholder: "如：xxx@xx.com" },

    { id: "fp_summary", label: "个人简介",   type: "textarea", rows: 4, placeholder: "用 1-2 句总结你的优势与方向" },
    { id: "fp_skills",  label: "技能（逗号分隔）", type: "input", placeholder: "如：PRD, 用户研究, JavaScript" },

    { id: "ed_school",  label: "学校",       type: "input",    placeholder: "如：复旦大学" },
    { id: "ed_major",   label: "专业",       type: "input",    placeholder: "如：计算机科学与技术" },
    { id: "ed_degree",  label: "学历",       type: "input",    placeholder: "如：本科/硕士" },

    { id: "ex_company", label: "公司",       type: "input",    placeholder: "如：某科技公司" },
    { id: "ex_title",   label: "职位",       type: "input",    placeholder: "如：产品经理/前端工程师" },
    { id: "ex_period",  label: "时间",       type: "input",    placeholder: "如：2022-06 ~ 2025-12" },

    { id: "pj_name",    label: "项目名称",   type: "input",    placeholder: "如：MY GIFT v4.1" },
    { id: "pj_desc",    label: "项目描述",   type: "textarea", rows: 3, placeholder: "一句话说明你做了什么、产出什么" },
  ],

  loadDB,
  setActive,
  writerName: "writeFactProfileDummy",
  setActiveMap: { fact_profile_id: "RET_ID" },

  // ✅ 回填：按 DB 真实结构读（basic/summary/skills/education/experience/projects）
  fillFromDB: (db) => {
    const fpId = db?.active?.fact_profile_id || null;
    const row = fpId ? db?.fact_profiles?.[fpId] : null;
    const p = row?.payload || row || {};

    const basic = p.basic || {};
    const edu0 = Array.isArray(p.education) ? (p.education[0] || {}) : {};
    const ex0  = Array.isArray(p.experience) ? (p.experience[0] || {}) : {};
    const pj0  = Array.isArray(p.projects) ? (p.projects[0] || {}) : {};

    return {
      fp_name:   basic.name || "",
      fp_target: basic.target || basic.title || "",
      fp_city:   basic.city || "",
      fp_phone:  basic.phone || "",
      fp_email:  basic.email || "",

      fp_summary: p.summary || "",
      fp_skills:  Array.isArray(p.skills) ? p.skills.join(", ") : (p.skills || ""),

      ed_school: edu0.school || "",
      ed_major:  edu0.major || "",
      ed_degree: edu0.degree || "",

      ex_company: ex0.company || "",
      ex_title:   ex0.title || "",
      ex_period:  ex0.period || "",

      pj_name: pj0.name || "",
      pj_desc: pj0.desc || "",
    };
  },

  // ✅ 构建 payload：写回 DB 的同一结构（这一步决定“预览/下载有没有内容”）
  buildPayload: () => {
    const v = (id) => (document.getElementById(id)?.value || "").toString().trim();

    const skillsStr = v("fp_skills");
    const skills = skillsStr
      ? skillsStr.split(/[,，\n]/).map(s => s.trim()).filter(Boolean)
      : [];

    const payload = {
      basic: {
        name: v("fp_name"),
        target: v("fp_target"),
        city: v("fp_city"),
        phone: v("fp_phone"),
        email: v("fp_email"),
      },
      summary: v("fp_summary"),
      skills,

      education: [{
        school: v("ed_school"),
        major:  v("ed_major"),
        degree: v("ed_degree"),
      }],

      experience: [{
        company: v("ex_company"),
        title:   v("ex_title"),
        period:  v("ex_period"),
      }],

      projects: [{
        name: v("pj_name"),
        desc: v("pj_desc"),
      }],
    };

    // ✅ 兼容 _step_page.js 的 Fact 保存逻辑
    window.__FACT_PAYLOAD__ = payload;

    return payload; // mountStepForm 会同步到 window.__STEP_PAYLOAD__
  },
});

console.log("[FACT][TEMPLATE_SPEC_VERSION]", FACT_SPEC_V0_2?.meta?.spec_version);
console.log("[FACT][TEMPLATE_VALIDATE_EMPTY]", validateFactData_v0_2({}));

</script>

</body>
</html>