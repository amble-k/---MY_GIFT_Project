<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Resume Product - Role Target</title>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import { bootStepPage } from "/apps/resume_product/pages/_step_page.js?v=9999";
    import { loadDB, setActive } from "/core/storage/resume_db.js";

    bootStepPage({ title:"Resume Product — Target Role", stepId:"role_target", writeFnName:"writeRoleTargetDummy" });

    const shell = document.getElementById("app");
    const host = document.createElement("div");
    host.id = "role_target_host";
    shell.appendChild(host);


    // （可选提示，不是下拉强制）
    const suggestions = [
      "产品经理","增长产品经理","B端产品经理","运营","用户运营","数据分析师",
      "前端工程师","后端工程师","测试工程师","算法工程师","UI/UX设计师"
    ];

    function render(initRoleText="", initNote=""){
      host.innerHTML = `
        <div style="max-width:920px;margin:16px auto 0;padding:0 12px;">
          <div style="border:1px solid #e9e9e9;border-radius:16px;background:#fff;padding:12px;">
            <div style="font-weight:900;font-size:14px;margin:0 0 8px 0;">目标岗位（输入）</div>
            <div style="font-size:12px;color:rgba(0,0,0,.6);margin:0 0 12px 0;">
              输入你要投递的目标岗位名称。下一步将基于岗位画像（AKSH）给出“需要强化的表达选项”。
            </div>

            <datalist id="role_suggest">
              ${suggestions.map(x=>`<option value="${x}"></option>`).join("")}
            </datalist>

            <div style="display:grid;grid-template-columns:110px 1fr;gap:10px;align-items:center;margin:8px 0;">
              <div style="font-size:12px;color:rgba(0,0,0,.70);">岗位</div>
              <input id="role_text" list="role_suggest" placeholder="如：增长产品经理 / 后端工程师"
                style="width:100%;padding:8px;box-sizing:border-box;border:1px solid #ddd;border-radius:12px;" />
            </div>

            <div style="display:grid;grid-template-columns:110px 1fr;gap:10px;align-items:center;margin:8px 0;">
              <div style="font-size:12px;color:rgba(0,0,0,.70);">备注</div>
              <input id="role_note" placeholder="可选：如 投递A公司/偏B端/偏增长"
                style="width:100%;padding:8px;box-sizing:border-box;border:1px solid #ddd;border-radius:12px;" />
            </div>
          </div>
        </div>
      `;

      // ✅ 回填 + 同步 payload（让顶部按钮可保存）
      try{
        const roleEl = document.getElementById("role_text");
        const noteEl = document.getElementById("role_note");
        if (roleEl) roleEl.value = (initRoleText || "");
        if (noteEl) noteEl.value = (initNote || "");

        const sync = () => {
          const payload = {
            role_text: (roleEl?.value || "").toString().trim(),
            role_note: (noteEl?.value || "").toString().trim(),
          };
          window.__STEP_PAYLOAD__ = payload;
          window.__ROLE_TARGET_PAYLOAD__ = payload;
        };

        roleEl && roleEl.addEventListener("input", sync);
        noteEl && noteEl.addEventListener("input", sync);
        sync();
      }catch(e){ console.warn("[role_target] sync failed", e); }

      const roleInput = document.getElementById("role_text");
      const noteInput = document.getElementById("role_note");
      roleInput.value = initRoleText || "";
      noteInput.value = initNote || "";

      const sync = ()=>{
        const payload = {
          role_text: (roleInput.value || "").trim(),
          role_note: (noteInput.value || "").trim(),
          meta:{ source:"role_target.v0.2.4-01" }
        };
        window.__STEP_PAYLOAD__ = payload;
        window.__ROLE_TARGET_PAYLOAD__ = payload;
      };

      app.addEventListener("input", sync, true);
      app.addEventListener("change", sync, true);
      sync();
    }

    // ✅ 回填：从 active.role_text / role_note
    (async ()=>{
      const db = await loadDB();
      const initRoleText = db?.active?.role_text || "";
      const initNote = db?.active?.role_note || "";
      render(initRoleText, initNote);
    })();
  </script>
</body>
</html>
