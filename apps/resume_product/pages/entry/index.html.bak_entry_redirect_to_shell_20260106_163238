<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Resume Product — Entry Hub</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Noto Sans", sans-serif; padding: 16px; line-height: 1.5; }
    button { margin: 6px 6px 6px 0; padding: 8px 12px; }
    .box { padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-top: 12px; }
    pre { white-space: pre-wrap; word-break: break-word; background: #fafafa; padding: 10px; border-radius: 10px; border: 1px solid #eee; }
    .hint { color: #666; font-size: 13px; }
  </style>
</head>
<body>
  <h1>Resume Product — Entry Hub</h1>
 <div class="hint" id="hint"></div>

  <div id="app" class="box">Loading...</div>

  <script type="module">

    // ENTRY_AUTO_DISPATCH_V0_2_4_09:
    // 只要 hash 不是 #/resume（Hub），就立刻用 router_runtime.dispatch() 切到正确物理页。
    // 这可以修复：卡在 /pages/entry/index.html#/resume/role_target 永远显示 HUB 的问题。
    (async () => {
      try {
        const h = location.hash || "";
        if (h && h !== "#" && h !== "#/resume") {
          const m = await import("/apps/resume_product/router_runtime.js?v=" + Date.now());
          const r = m.dispatch();
          // dispatch 里会 location.replace；这里不需要再做事
          console.log("[entry][autodispatch]", { hash: h, ret: r });
        }
      } catch (e) {
        console.warn("[entry][autodispatch] failed", e);
      }
    })();

    import { bootPage } from "/apps/resume_product/app_boot.js";
    import { dispatch } from "/apps/resume_product/router_runtime.js";
    dispatch();

    import { RouteMap, StepId, STEP_ORDER } from "/core/session/step_ids.js";
    import { resetResumeDB, ensureSession } from "/core/actions/v0_1_actions.js?v=2";

    function btn(text, onClick) {
      const b = document.createElement("button");
      b.textContent = text;
      b.onclick = onClick;
      return b;
    }

    bootPage({
      render: ({ db, st, route }) => {
        const app = document.getElementById("app");
        app.innerHTML = "";

        const isDebug = new URLSearchParams(location.search).get("debug") === "1";
        const hasSession = !!st?.active_ids?.session_id;

const hintEl = document.getElementById("hint");
if (hintEl) {
  hintEl.textContent = isDebug
    ? `route=${location.hash || ""} | state=${st?.state} | required_step=${st?.required_step} | hasSession=${hasSession}`
    : "";
}

if (isDebug) {
  console.log("[entry]", {
    hash: location.hash,
    state: st?.state,
    required_step: st?.required_step,
    hasSession,
  });
}
        // ✅ 进度口径：按 STEP_ORDER（排除 entry）= 与 step 页分页一致
        const PROGRESS_ORDER = STEP_ORDER.filter((x) => x !== StepId.entry);
        const totalCount = PROGRESS_ORDER.length;

        let doneCount = 0;
        if (hasSession) {
          const cur =
            (st?.required_step && PROGRESS_ORDER.includes(st.required_step)) ? st.required_step :
            (st?.state && PROGRESS_ORDER.includes(st.state)) ? st.state :
            StepId.scenario;

          const idx = PROGRESS_ORDER.indexOf(cur);
          doneCount = idx >= 0 ? (idx + 1) : 1;
        }

        const canDownload = !!db?.export_ready && !!db?.active?.resume_version_id;

        // 顶部摘要（用户可读）
        const summary = document.createElement("div");
        summary.style.cssText = "margin:8px 0 12px 0;";
        summary.innerHTML = `
          <div style="font-size:14px;margin-bottom:6px;">
            当前进度：<b>${doneCount}/${totalCount}</b>
          </div>
          <div style="color:#666;font-size:13px;">
            ${!hasSession ? "还没有开始流程，点击“开始制作简历”进入第一步。" : (canDownload ? "已可下载简历（TXT）。" : "流程已开始，可继续编辑并生成简历。")}
          </div>
        `;
        app.appendChild(summary);

        // debug 信息（仅 debug=1）
        if (isDebug) {
          const hint = document.createElement("div");
          hint.style.cssText = "margin:6px 0;color:#666;font-size:12px;";
          hint.textContent = `route: ${route} | state: ${st?.state} | required_step: ${st?.required_step ?? "null"}`;
          app.appendChild(hint);

          const pre = document.createElement("pre");
          pre.textContent = JSON.stringify({ milestones: st.milestones, active_ids: st.active_ids }, null, 2);
          app.appendChild(pre);
        }

        const actions = document.createElement("div");
        app.appendChild(actions);

        // 主按钮：开始 / 继续 / 下载
        if (!hasSession) {
          actions.appendChild(btn("开始制作简历", () => {
ensureSession();
            location.replace("/apps/resume_product/index.html#/resume/scenario");
          }));
        } else if (!canDownload) {
          actions.appendChild(btn("继续编辑", () => {
            const nextRoute =
              (st?.required_step && RouteMap?.[st.required_step])
                ? RouteMap[st.required_step]
                : "/resume/scenario";
            location.replace("/apps/resume_product/index.html#" + nextRoute);
          }));
        } else {
          actions.appendChild(btn("下载（TXT）", () => {
            location.replace("/apps/resume_product/index.html#/resume/export");
          }));
        }

        // 次按钮：清空
        actions.appendChild(btn("清空重来", () => {
          resetResumeDB();
          location.replace("/apps/resume_product/index.html#/resume");
        }));

        // Debug：Health
        if (isDebug) {
          actions.appendChild(btn("Health Check（debug）", () => {
            location.replace("/apps/resume_product/pages/_health/index.html?v=" + Date.now() + "#/health");
          }));
        }
      },
    });
  </script>
</body>
</html>