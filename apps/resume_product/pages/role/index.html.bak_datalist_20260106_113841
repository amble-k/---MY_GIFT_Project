<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Resume Product - Role</title>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import { bootStepPage } from "/apps/resume_product/pages/_step_page.js?v=3";
    import { loadDB, setActive } from "/core/storage/resume_db.js";
    import { mountStepForm } from "/core/ui/step_form_v0_2.js?v=2";

    // 通用壳（按钮会读 window.__STEP_PAYLOAD__）
    bootStepPage({ title:"Resume Product — Role", stepId:"role_profile", writeFnName:"writeRoleDummy" });

    // 统一表单 + payload + 自动保存
    mountStepForm({
      title: "岗位信息（最小版）",
      desc: "说明：输入后将自动保存（不跳页）。进入下一步仍可用上方“写入/保存并进入下一步”。",
      fields: [
        { id: "role_name", label: "目标岗位名", type: "input", placeholder: "如：后端工程师 / 产品经理 / 咨询经理", key: "role_name" },
        { id: "role_jd", label: "岗位JD（简要）", type: "textarea", rows: 6, placeholder: "粘贴或概括 JD 的关键要求（可选）", key: "jd" },
      ],
      loadDB,
      setActive,
      writerName: "writeRoleDummy",
      setActiveMap: { role_id: "RET_ID" },

      // 回填：优先 roles，其次 role_profiles（兼容）
      fillFromDB: (db) => {
        const sid = db?.active?.session_id || null;
        const rid = db?.active?.role_id || (sid ? db?.sessions?.[sid]?.role_id : null) || null;

        const r =
          (rid && db?.roles?.[rid]) ? db.roles[rid] :
          (rid && db?.role_profiles?.[rid]) ? db.role_profiles[rid] :
          null;

        const p = r?.payload || r || {};
        return {
          role_name: p?.role_name || p?.name || "",
          jd: p?.jd || p?.note || "",
        };
      },
    });
  </script>
</body>
</html>