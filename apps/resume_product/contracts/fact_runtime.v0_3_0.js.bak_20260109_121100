// apps/resume_product/contracts/fact_runtime.v0_3_0.js
// Fact v0.3.0 runtime helpers: init / adapt / validate (minimal)

import { FACT_SCHEMA_V0_3_0 } from "./fact_schema.v0_3_0.js";

function iso(d = new Date()) { return d.toISOString(); }
function isNonEmptyStr(x) { return typeof x === "string" && x.trim().length > 0; }
function asArray(x) { return Array.isArray(x) ? x : (x == null ? [] : [x]); }

// ---- 1) Create empty Fact v0.3 ----
export function makeEmptyFactV03({ locale = "zh-CN" } = {}) {
  return {
    schema_version: FACT_SCHEMA_V0_3_0.version,
    created_at: iso(),
    updated_at: iso(),
    locale,
    privacy: { mode: "normal" },
    meta: { source: "manual", confidence: 1, gaps: [] },

    person: {
      name: "",
      location: { city: "", country: "" },
      contact: { email: "", phone: "", wechat: "", github: "", website: "", linkedin: "" },
      headline: "",
      summary: "",
      tags: [],
    },

    education: [],
    experience: [],
    projects: [],
    skills: { hard: [], soft: [], tools: [], languages: [] },
    certificates: [],
    awards: [],
    publications: [],
    volunteering: [],
    interests: [],
  };
}

// ---- 2) Normalize (fill meta, updated_at) ----
export function normalizeFactV03(input = {}, { locale = "zh-CN" } = {}) {
  const base = makeEmptyFactV03({ locale });
  const out = { ...base, ...(input || {}) };

  // deep-ish merges for common nested groups
  out.privacy = { ...(base.privacy || {}), ...(out.privacy || {}) };
  out.meta = { ...(base.meta || {}), ...(out.meta || {}) };
  out.person = { ...(base.person || {}), ...(out.person || {}) };
  out.person.location = { ...(base.person.location || {}), ...(out.person.location || {}) };
  out.person.contact = { ...(base.person.contact || {}), ...(out.person.contact || {}) };
  out.skills = { ...(base.skills || {}), ...(out.skills || {}) };

  out.schema_version = FACT_SCHEMA_V0_3_0.version;
  out.updated_at = iso();
  if (!out.created_at) out.created_at = iso();

  // force arrays
  out.education = asArray(out.education);
  out.experience = asArray(out.experience);
  out.projects = asArray(out.projects);

  // sanitize tags
  out.person.tags = asArray(out.person.tags).filter(isNonEmptyStr);

  return out;
}

// ---- 3) Adapt legacy Fact (current v0.2-ish structures) -> v0.3 ----
// Supports shapes like:
// - { basic, summary, skills, education, experience, projects } (your fact_profiles payload)
// - { person, education, experience, projects } (already new-ish)
export function adaptLegacyFactToV03(legacy = {}, { locale = "zh-CN" } = {}) {
  // already v0.3-ish
  if (legacy?.schema_version === FACT_SCHEMA_V0_3_0.version) return normalizeFactV03(legacy, { locale });

  const out = makeEmptyFactV03({ locale });

  // v0.2: basic
  const basic = legacy?.basic || {};
  const personName = basic?.name || legacy?.person?.name || "";
  out.person.name = String(personName || "");

  // contacts
  out.person.contact.email = String(basic?.email || legacy?.person?.contact?.email || "");
  out.person.contact.phone = String(basic?.phone || legacy?.person?.contact?.phone || "");
  out.person.contact.wechat = String(basic?.wechat || legacy?.person?.contact?.wechat || "");
  out.person.contact.github = String(basic?.github || legacy?.person?.contact?.github || "");
  out.person.contact.website = String(basic?.website || legacy?.person?.contact?.website || "");
  out.person.contact.linkedin = String(basic?.linkedin || legacy?.person?.contact?.linkedin || "");

  // location/headline/summary
  out.person.location.city = String(basic?.city || legacy?.person?.location?.city || "");
  out.person.location.country = String(basic?.country || legacy?.person?.location?.country || "");
  out.person.headline = String(basic?.title || legacy?.person?.headline || "");
  out.person.summary = String(legacy?.summary || legacy?.person?.summary || "");

  // v0.2 arrays
  out.education = asArray(legacy?.education);
  out.experience = asArray(legacy?.experience);
  out.projects = asArray(legacy?.projects);

  // skills (try best-effort)
  const skills = legacy?.skills;
  if (Array.isArray(skills)) {
    out.skills.hard = skills.filter(isNonEmptyStr);
  } else if (skills && typeof skills === "object") {
    out.skills = { ...out.skills, ...skills };
  }

  return normalizeFactV03(out, { locale });
}

// ---- 4) Minimal validation (only rules we already wrote in schema.rules) ----
export function validateFactV03(factInput) {
  const fact = normalizeFactV03(factInput || {});
  const errors = [];

  const email = fact?.person?.contact?.email || "";
  const phone = fact?.person?.contact?.phone || "";
  if (!isNonEmptyStr(email) && !isNonEmptyStr(phone)) {
    errors.push({ id: "L1_CONTACT_ONE_REQUIRED", message: "邮箱/电话至少填写一个" });
  }

  const exps = Array.isArray(fact.experience) ? fact.experience : [];
  if (exps.length < 1) {
    errors.push({ id: "L1_EXPERIENCE_MIN1", message: "请至少填写一条工作经历" });
  } else {
    exps.forEach((e, i) => {
      const company = e?.company?.name;
      const role = e?.role?.title;
      const start = e?.start_date;
      if (!isNonEmptyStr(company) || !isNonEmptyStr(role) || !isNonEmptyStr(start)) {
        errors.push({
          id: "L1_EXPERIENCE_CORE_FIELDS",
          message: `第 ${i + 1} 条经历至少需要：公司、岗位、开始时间`,
          index: i,
        });
      }
      const respN = asArray(e?.responsibilities).filter(isNonEmptyStr).length;
      const achN = asArray(e?.achievements).filter((x) => {
        if (typeof x === "string") return isNonEmptyStr(x);
        if (x && typeof x === "object") return isNonEmptyStr(x.text);
        return false;
      }).length;
      if ((respN + achN) < 2) {
        errors.push({
          id: "L1_EXPERIENCE_DESC_MIN2",
          message: `第 ${i + 1} 条经历请至少填写 2 条要点（职责+成果合计）`,
          index: i,
        });
      }
    });
  }

  return { ok: errors.length === 0, errors, fact };
}
