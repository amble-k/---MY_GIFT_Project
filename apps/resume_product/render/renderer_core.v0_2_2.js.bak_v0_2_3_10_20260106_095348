/**
 * Resume Product - Renderer Core
 * v0.2.2
 *
 * 目标：
 * - 纯函数：renderResumeHtml_v0_2_2(resumeDoc, themeTokens) -> html string
 * - 不读 DOM、不写 DOM、不依赖页面环境
 * - 只消费 ResumeDoc（唯一真相）与 ThemeTokens（视觉标准）
 *
 * 本文件只实现“专业简历最小闭环”：
 * - Header（姓名/定位/联系方式）
 * - Summary（bullets）
 * - Skills（分组 chips）
 * 其他 section 先占位，后续逐步补齐。
 */

function s(v) { return (v == null ? "" : String(v)).trim(); }
function esc(v) {
  return s(v)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}
function css(obj) {
  // 把 {a:"1", b:"2"} -> "a:1;b:2;"
  return Object.entries(obj || {}).map(([k,v]) => `${k}:${v};`).join("");
}
function isArr(a) { return Array.isArray(a); }

function renderHeader(doc, t) {
  const name = esc(doc?.header?.name || "");
  const titleLine = esc(doc?.header?.titleLine || "");
  const contactLine = esc(doc?.header?.contactLine || "");

  const card = t.components.card;
  const h1 = t.typography.h1;
  const small = t.typography.small;
  const sub = t.color.subText;

  return `
    <div style="${css({ padding: card.padding, border: card.border, "border-radius": card.radius, background: card.bg })}">
      <div style="${css({ display:"flex", "justify-content":"space-between", gap:t.layout.headerSplitGap, "align-items":"flex-end", "flex-wrap":"wrap" })}">
        <div>
          <div style="${css({ color:t.color.text, "font-size":h1.fontSize, "font-weight":h1.fontWeight, "line-height":h1.lineHeight, "letter-spacing":h1.letterSpacing })}">${name || "（未填写姓名）"}</div>
          <div style="${css({ margin:"4px 0 0 0", color:sub, "font-size":small.fontSize, "line-height":small.lineHeight })}">
            ${titleLine}
          </div>
        </div>
        <div style="${css({ color:sub, "font-size":small.fontSize, "line-height":small.lineHeight, "text-align":"right" })}">
          ${contactLine}
        </div>
      </div>
    </div>
  `;
}

function renderSectionTitle(title, id, t) {
  const h2 = t.typography.h2;
  return `
    <div style="${css({ margin:"0 0 "+t.spacing.sm+" 2px", color:t.color.text, "font-size":h2.fontSize, "font-weight":h2.fontWeight, "letter-spacing":h2.letterSpacing })}">
      ${esc(title)} <span style="${css({ color:t.color.faint, "font-weight":"500" })}">(${esc(id)})</span>
    </div>
  `;
}

function renderSummary(doc, t) {
  const bullets = doc?.summary?.bullets;
  const body = t.typography.body;
  const card = t.components.card;

  const items = isArr(bullets) ? bullets : [];
  const li = items.length
    ? items.map(b => `<li style="${css({ margin:"0 0 "+t.spacing.xs+" 0" })}">${esc(b?.text ?? b)}</li>`).join("")
    : `<li style="${css({ color:t.color.faint })}">（建议生成 2-4 条要点式简介）</li>`;

  return `
    <div style="${css({ padding: card.padding, border: t.shape.borderThin, "border-radius": t.shape.radiusCard, background: t.color.bg })}">
      <div style="${css({ color:t.color.text, "font-size":body.fontSize, "line-height":body.lineHeight })}">
        <ul style="${css({ margin:0, padding:"0 0 0 18px" })}">${li}</ul>
      </div>
    </div>
  `;
}

function renderSkills(doc, t) {
  const groups = doc?.skills?.groups;
  const chip = t.components.chip;
  const body = t.typography.body;

  const g = isArr(groups) ? groups : [];
  if (!g.length) {
    return `<div style="${css({ color:t.color.faint, "font-size":body.fontSize })}">（建议至少选择 6 个技能标签）</div>`;
  }

  return g.map(grp => {
    const label = esc(grp?.label || "技能");
    const items = isArr(grp?.items) ? grp.items.map(s).filter(Boolean) : [];
    const chips = items.length
      ? items.map(it => `<span style="${css({ display:"inline-block", margin:"6px 8px 0 0", padding: chip.padding, border: chip.border, "border-radius": chip.radius, "font-size": t.typography.small.fontSize, color:t.color.text })}">${esc(it)}</span>`).join("")
      : `<span style="${css({ color:t.color.faint, "font-size": t.typography.small.fontSize })}">（空）</span>`;

    return `
      <div>
        <div style="${css({ color:t.color.subText, "font-size": t.typography.small.fontSize, "font-weight":"700", margin:"0 0 6px 2px" })}">${label}</div>
        <div>${chips}</div>
      </div>
    `;
  }).join(`<div style="height:${t.spacing.md};"></div>`);
}


// v0.2.2-09: experience_timeline
function renderExperienceTimeline(doc, t) {
  const items = Array.isArray(doc?.experience) ? doc.experience : [];
  const body = t.typography.body;
  const small = t.typography.small;

  if (!items.length) return renderPlaceholder("（暂无工作经历）", t);

  const cards = items.map((it) => {
    const company = esc(it?.company || "");
    const role = esc(it?.role || "");
    const period = esc(it?.period || "");

    // v0.2.3-09：按 rule_id 拆分（职责/成果），否则 fallback 到全部 bullets
    const bullets = Array.isArray(it?.bullets) ? it.bullets : [];
    const { a: resp, b: achv, rest } = splitBulletsByRule(bullets, "RULE_FREE_RESP", "RULE_FREE_ACHV");
    const fallback = bullets;

    const headerLeft = `
      <div style="${css({ display:"grid", gap:"2px" })}">
        <div style="${css({ color:t.color.text, "font-weight":"900", "font-size":body.fontSize })}">${company || "（公司）"}</div>
        <div style="${css({ color:t.color.subText, "font-size":small.fontSize })}">${role || ""}</div>
      </div>
    `;
    const headerRight = `
      <div style="${css({ color:t.color.subText, "font-size":small.fontSize, "white-space":"nowrap" })}">
        ${period}
      </div>
    `;

    const block = `
      <div style="${css({ padding:t.components.card.padding, border:t.components.card.border, "border-radius":t.components.card.radius, background:t.components.card.bg })}">
        <div style="${css({ display:"flex", "justify-content":"space-between", gap:t.spacing.md, "align-items":"flex-start" })}">
          ${headerLeft}
          ${headerRight}
        </div>

        ${resp.length || achv.length ? `
          ${renderLabeledBullets("职责 / Responsibilities", resp, t)}
          ${renderLabeledBullets("成果 / Achievements", achv, t)}
          ${rest.length ? renderLabeledBullets("补充 / Notes", rest, t) : ""}
        ` : `
          ${renderLabeledBullets("要点 / Highlights", fallback, t)}
        `}
      </div>
    `;
    return block;
  }).join(`<div style="height:${t.spacing.md};"></div>`);

  return `<div>${cards}</div>`;
}

// v0.2.2-10: projects_cards
function renderProjectsCards(doc, t) {
  const items = Array.isArray(doc?.projects) ? doc.projects : [];
  const body = t.typography.body;
  const small = t.typography.small;

  if (!items.length) return renderPlaceholder("（暂无项目经历）", t);

  const cards = items.map((it) => {
    const name = esc(it?.name || "");
    const tagline = esc(it?.tagline || ""); // 期望：主导/参与 · 时间
    const stack = Array.isArray(it?.stack) ? it.stack : [];
    const bullets = Array.isArray(it?.bullets) ? it.bullets : [];

    // v0.2.3-09：按 rule_id 拆分（项目职责/项目成果）
    const { a: work, b: achv, rest } = splitBulletsByRule(bullets, "RULE_FREE_PJ_WORK", "RULE_FREE_PJ_ACHV");

    const chips = []
    if (tagline) chips.push(tagline)
    if (stack.length) chips.push(stack.slice(0,6).map(esc).join(" · "))

    return `
      <div style="${css({ padding:t.components.card.padding, border:t.components.card.border, "border-radius":t.components.card.radius, background:t.components.card.bg })}">
        <div style="${css({ display:"grid", gap:"6px" })}">
          <div style="${css({ display:"flex", "justify-content":"space-between", gap:t.spacing.md, "align-items":"baseline", "flex-wrap":"wrap" })}">
            <div style="${css({ color:t.color.text, "font-weight":"900", "font-size":body.fontSize })}">${name || "（项目）"}</div>
          </div>

          ${chips.length ? `
            <div style="${css({ color:t.color.subText, "font-size":small.fontSize })}">
              ${chips.map(c=>`<span style="${css({ display:"inline-block", padding:"2px 8px", border:"1px solid #e9e9e9", "border-radius":"999px", margin:"0 6px 6px 0", background:"#fff" })}">${c}</span>`).join("")}
            </div>
          ` : ""}

          ${renderLabeledBullets("项目职责 / Responsibilities", work.length?work:bullets, t)}
          ${renderLabeledBullets("项目成果 / Achievements", achv, t)}
          ${rest.length ? renderLabeledBullets("补充 / Notes", rest, t) : ""}
        </div>
      </div>
    `;
  }).join(`<div style="height:${t.spacing.md};"></div>`);

  return `<div>${cards}</div>`;
}

// v0.2.2-11: education_rows
function renderEducationRows(doc, t) {
  const edu = doc?.education;
  const items = Array.isArray(edu) ? edu : [];
  const body = t.typography.body;
  const small = t.typography.small;

  if (!items.length) {
    return renderPlaceholder("（暂无教育背景：可补充学校/专业/学历）", t);
  }

  const rows = items.slice(0, 2).map((it) => {
    const school = esc(it?.school || "");
    const major = esc(it?.major || "");
    const degree = esc(it?.degree || "");
    const extra = esc(it?.extra || "");

    const right = [degree, extra].filter(Boolean).join(" · ");

    return `
      <div style="${css({ display:"flex", "justify-content":"space-between", gap:t.spacing.sm, "align-items":"baseline", "flex-wrap":"wrap" })}">
        <div style="${css({ color:t.color.text, "font-size":body.fontSize, "font-weight":"800" })}">
          ${school || "（学校）"}
          ${major ? `<span style="${css({ color:t.color.subText, "font-weight":"600", margin:"0 0 0 8px" })}">${major}</span>` : ""}
        </div>
        <div style="${css({ color:t.color.subText, "font-size":small.fontSize })}">${right}</div>
      </div>
    `;
  }).join(`<div style="height:${t.spacing.xs};"></div>`);

  return `
    <div style="${css({ padding: t.components.card.padding, border: t.components.card.border, "border-radius": t.components.card.radius, background: t.components.card.bg })}">
      ${rows}
    </div>
  `;
}


// v0.2.3-03: certifications_rows + trainings_rows
function renderCertificationsRows(doc, t) {
  const items = Array.isArray(doc?.certifications) ? doc.certifications : [];
  const body = t.typography.body;
  const small = t.typography.small;

  if (!items.length) {
    return renderPlaceholder("（暂无证书：可补充证书名称/机构/时间）", t);
  }

  const rows = items.slice(0, 6).map((it) => {
    const name = esc(it?.name || "");
    const issuer = esc(it?.issuer || "");
    const date = esc(it?.date || "");
    const right = [issuer, date].filter(Boolean).join(" · ");

    return `
      <div style="${css({ display:"flex", "justify-content":"space-between", gap:t.spacing.sm, "align-items":"baseline", "flex-wrap":"wrap" })}">
        <div style="${css({ color:t.color.text, "font-size":body.fontSize, "font-weight":"800" })}">
          ${name || "（证书）"}
        </div>
        <div style="${css({ color:t.color.subText, "font-size":small.fontSize })}">${right}</div>
      </div>
    `;
  }).join(`<div style="height:${t.spacing.xs};"></div>`);

  return `
    <div style="${css({ padding: t.components.card.padding, border: t.components.card.border, "border-radius": t.components.card.radius, background: t.components.card.bg })}">
      ${rows}
    </div>
  `;
}

function renderTrainingsRows(doc, t) {
  const items = Array.isArray(doc?.trainings) ? doc.trainings : [];
  const body = t.typography.body;
  const small = t.typography.small;

  if (!items.length) {
    return renderPlaceholder("（暂无培训经历：可补充课程/机构/时间/内容）", t);
  }

  const rows = items.slice(0, 6).map((it) => {
    const name = esc(it?.name || "");
    const org = esc(it?.org || "");
    const when = esc(it?.date_or_period || "");
    const content = esc(it?.content || "");
    const right = [org, when].filter(Boolean).join(" · ");

    return `
      <div style="${css({ display:"grid", gap:t.spacing.xs })}">
        <div style="${css({ display:"flex", "justify-content":"space-between", gap:t.spacing.sm, "align-items":"baseline", "flex-wrap":"wrap" })}">
          <div style="${css({ color:t.color.text, "font-size":body.fontSize, "font-weight":"800" })}">
            ${name || "（培训）"}
          </div>
          <div style="${css({ color:t.color.subText, "font-size":small.fontSize })}">${right}</div>
        </div>
        ${content ? `<div style="${css({ color:t.color.subText, "font-size":small.fontSize, "line-height":small.lineHeight })}">${content}</div>` : ""}
      </div>
    `;
  }).join(`<div style="height:${t.spacing.md};"></div>`);

  return `
    <div style="${css({ padding: t.components.card.padding, border: t.components.card.border, "border-radius": t.components.card.radius, background: t.components.card.bg })}">
      ${rows}
    </div>
  `;
}

function renderPlaceholder(text, t) {
  return `
    <div style="${css({ padding:t.spacing.sm+" "+t.spacing.md, border:t.shape.borderDash, "border-radius":t.shape.radiusCard, color:t.color.subText, "font-size":t.typography.small.fontSize })}">
      ${esc(text)}
    </div>
  `;
}

// v0.2.3-09: formatted experience/projects with labeled elements
function splitBulletsByRule(bullets, ruleA, ruleB){
  const a = [];
  const b = [];
  const rest = [];
  const arr = Array.isArray(bullets) ? bullets : [];
  for (const it of arr){
    const rid = (it && it.rule_id) ? String(it.rule_id) : "";
    const txt = (it && it.text) ? String(it.text) : "";
    if (!txt.trim()) continue;
    if (ruleA && rid === ruleA) a.push(it);
    else if (ruleB && rid === ruleB) b.push(it);
    else rest.push(it);
  }
  return { a, b, rest };
}
function renderLabeledBullets(label, bullets, t){
  const small = t.typography.small;
  const body = t.typography.body;
  const list = (Array.isArray(bullets) ? bullets : []).map(b=>`<li style="${css({ "margin":"0 0 6px 0" })}">${esc(b.text)}</li>`).join("");
  if (!list) return "";
  return `
    <div style="${css({ margin: "10px 0 0 0" })}">
      <div style="${css({ color:t.color.subText, "font-size":small.fontSize, "letter-spacing":"0.02em", "margin":"0 0 6px 0" })}">${esc(label)}</div>
      <ul style="${css({ margin:"0 0 0 18px", padding:"0", color:t.color.text, "font-size":body.fontSize, "line-height":body.lineHeight })}">
        ${list}
      </ul>
    </div>
  `;
}


/**
 * renderResumeHtml_v0_2_2
 * - 输出一个“预览容器 + 内容”的 HTML 字符串
 * - 页面可直接 innerHTML = renderResumeHtml...
 */
export function renderResumeHtml_v0_2_2(resumeDoc, theme, outputSpec) {
  const t = theme;
  const wrapStyle = css({
    width: t.page.width,
    "max-width": t.page.maxWidth,
    padding: t.page.padding,
    margin: "0 auto",
    background: t.color.bg,
    color: t.color.text,
    "box-sizing": "border-box",
  });

  // v0.2.2-08: spec-driven rendering
  const specSections = outputSpec?.sections;
  const useSpec = Array.isArray(specSections) && specSections.length > 0;

  // fallback（旧逻辑，向后兼容）
const sections = [
    { id: "header", title: "Header", html: renderHeader(resumeDoc, t) },
    { id: "summary", title: "Summary", html: renderSummary(resumeDoc, t) },
    { id: "skills", title: "Skills", html: renderSkills(resumeDoc, t) },
    { id: "experience", title: "Experience", html: renderPlaceholder("Experience（下一步实现时间线）", t) },
    { id: "projects", title: "Projects", html: renderPlaceholder("Projects（下一步实现项目卡片）", t) },
    { id: "education", title: "Education", html: renderPlaceholder("Education（下一步实现教育列表）", t) },
  ];

  const sections2 = useSpec ? specSections.map(sec => {
    const id = sec?.id || "";
    const titleObj = sec?.title || {};
    const title = titleObj.zh || titleObj.en || String(id || "Section");
    const blocks = Array.isArray(sec?.blocks) ? sec.blocks : [];

    // 将 blocks 映射为 html（首批支持：header_card/summary_bullets/skills_grouped；其他占位）
    const html = blocks.map(b => {
      const t = b?.type;
      if (t === "header_card") return renderHeader(resumeDoc, theme);
      if (t === "summary_bullets") return renderSummary(resumeDoc, theme);
      if (t === "skills_grouped") return renderSkills(resumeDoc, theme);
      if (t === "experience_timeline") return renderExperienceTimeline(resumeDoc, theme);
      if (t === "projects_cards") return renderProjectsCards(resumeDoc, theme);
      if (t === "education_rows") return renderEducationRows(resumeDoc, theme);
      if (t === "certifications_rows") return renderCertificationsRows(resumeDoc, theme);
      if (t === "trainings_rows") return renderTrainingsRows(resumeDoc, theme);
      return renderPlaceholder(`${b?.id || ""} · ${t || ""}（待实现）`, theme);
    }).join(`<div style="height:${theme.layout.blockGap};"></div>`);

    return { id, title, html };
  }) : sections;
  const body = sections2.map(sec => {
    const title = renderSectionTitle(sec.title, sec.id, t);
    return `
      <div style="${css({ margin: t.layout.sectionGap+" 0 0 0" })}">
        ${title}
        <div style="${css({ display:"grid", gap: t.layout.blockGap })}">
          ${sec.html}
        </div>
      </div>
    `;
  }).join("");

  return `<div style="${wrapStyle}">${body}</div>`;
}
