/**
 * Resume Product - Renderer Core
 * v0.2.2
 *
 * 目标：
 * - 纯函数：renderResumeHtml_v0_2_2(resumeDoc, themeTokens) -> html string
 * - 不读 DOM、不写 DOM、不依赖页面环境
 * - 只消费 ResumeDoc（唯一真相）与 ThemeTokens（视觉标准）
 *
 * 本文件只实现“专业简历最小闭环”：
 * - Header（姓名/定位/联系方式）
 * - Summary（bullets）
 * - Skills（分组 chips）
 * 其他 section 先占位，后续逐步补齐。
 */

function s(v) { return (v == null ? "" : String(v)).trim(); }
function esc(v) {
  return s(v)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}
function css(obj) {
  // 把 {a:"1", b:"2"} -> "a:1;b:2;"
  return Object.entries(obj || {}).map(([k,v]) => `${k}:${v};`).join("");
}
function isArr(a) { return Array.isArray(a); }

function renderHeader(doc, t) {
  const name = esc(doc?.header?.name || "");
  const titleLine = esc(doc?.header?.titleLine || "");
  const contactLine = esc(doc?.header?.contactLine || "");

  const card = t.components.card;
  const h1 = t.typography.h1;
  const small = t.typography.small;
  const sub = t.color.subText;

  return `
    <div style="${css({ padding: card.padding, border: card.border, "border-radius": card.radius, background: card.bg })}">
      <div style="${css({ display:"flex", "justify-content":"space-between", gap:t.layout.headerSplitGap, "align-items":"flex-end", "flex-wrap":"wrap" })}">
        <div>
          <div style="${css({ color:t.color.text, "font-size":h1.fontSize, "font-weight":h1.fontWeight, "line-height":h1.lineHeight, "letter-spacing":h1.letterSpacing })}">${name || "（未填写姓名）"}</div>
          <div style="${css({ margin:"4px 0 0 0", color:sub, "font-size":small.fontSize, "line-height":small.lineHeight })}">
            ${titleLine}
          </div>
        </div>
        <div style="${css({ color:sub, "font-size":small.fontSize, "line-height":small.lineHeight, "text-align":"right" })}">
          ${contactLine}
        </div>
      </div>
    </div>
  `;
}

function renderSectionTitle(title, id, t) {
  const h2 = t.typography.h2;
  return `
    <div style="${css({ margin:"0 0 "+t.spacing.sm+" 2px", color:t.color.text, "font-size":h2.fontSize, "font-weight":h2.fontWeight, "letter-spacing":h2.letterSpacing })}">
      ${esc(title)} <span style="${css({ color:t.color.faint, "font-weight":"500" })}">(${esc(id)})</span>
    </div>
  `;
}

function renderSummary(doc, t) {
  const bullets = doc?.summary?.bullets;
  const body = t.typography.body;
  const card = t.components.card;

  const items = isArr(bullets) ? bullets : [];
  const li = items.length
    ? items.map(b => `<li style="${css({ margin:"0 0 "+t.spacing.xs+" 0" })}">${esc(b?.text ?? b)}</li>`).join("")
    : `<li style="${css({ color:t.color.faint })}">（建议生成 2-4 条要点式简介）</li>`;

  return `
    <div style="${css({ padding: card.padding, border: t.shape.borderThin, "border-radius": t.shape.radiusCard, background: t.color.bg })}">
      <div style="${css({ color:t.color.text, "font-size":body.fontSize, "line-height":body.lineHeight })}">
        <ul style="${css({ margin:0, padding:"0 0 0 18px" })}">${li}</ul>
      </div>
    </div>
  `;
}

function renderSkills(doc, t) {
  const groups = doc?.skills?.groups;
  const chip = t.components.chip;
  const body = t.typography.body;

  const g = isArr(groups) ? groups : [];
  if (!g.length) {
    return `<div style="${css({ color:t.color.faint, "font-size":body.fontSize })}">（建议至少选择 6 个技能标签）</div>`;
  }

  return g.map(grp => {
    const label = esc(grp?.label || "技能");
    const items = isArr(grp?.items) ? grp.items.map(s).filter(Boolean) : [];
    const chips = items.length
      ? items.map(it => `<span style="${css({ display:"inline-block", margin:"6px 8px 0 0", padding: chip.padding, border: chip.border, "border-radius": chip.radius, "font-size": t.typography.small.fontSize, color:t.color.text })}">${esc(it)}</span>`).join("")
      : `<span style="${css({ color:t.color.faint, "font-size": t.typography.small.fontSize })}">（空）</span>`;

    return `
      <div>
        <div style="${css({ color:t.color.subText, "font-size": t.typography.small.fontSize, "font-weight":"700", margin:"0 0 6px 2px" })}">${label}</div>
        <div>${chips}</div>
      </div>
    `;
  }).join(`<div style="height:${t.spacing.md};"></div>`);
}


// v0.2.2-09: experience_timeline
function renderExperienceTimeline(doc, t) {
  const exp = doc?.experience;
  const items = Array.isArray(exp) ? exp : [];
  const body = t.typography.body;
  const small = t.typography.small;

  if (!items.length) {
    return renderPlaceholder("（暂无工作经历：建议至少补充 1 段公司/职位/时间）", t);
  }

  const rows = items.slice(0, t?.gates?.experience?.max_items || 6).map((it, idx) => {
    const company = esc(it?.company || "");
    const role = esc(it?.role || "");
    const period = esc(it?.period || "");
    const bullets = Array.isArray(it?.bullets) ? it.bullets : [];

    const bulletHtml = bullets.length
      ? `<ul style="${css({ margin:0, padding:"0 0 0 18px" })}">
           ${bullets.slice(0, 4).map(b => `<li style="${css({ margin:"0 0 "+t.spacing.xs+" 0" })}">${esc(b?.text ?? b)}</li>`).join("")}
         </ul>`
      : `<div style="${css({ color:t.color.faint, "font-size": small.fontSize })}">（建议补充 2-3 条要点，突出动作与结果）</div>`;

    return `
      <div style="${css({ display:"grid", gap:t.spacing.xs })}">
        <div style="${css({ display:"flex", "justify-content":"space-between", gap:t.spacing.sm, "align-items":"baseline", "flex-wrap":"wrap" })}">
          <div style="${css({ color:t.color.text, "font-size": body.fontSize, "font-weight":"800" })}">
            ${company || "（公司）"}
            <span style="${css({ color:t.color.subText, "font-weight":"600", margin:"0 0 0 8px" })}">${role}</span>
          </div>
          <div style="${css({ color:t.color.subText, "font-size": small.fontSize })}">${period}</div>
        </div>
        <div style="${css({ color:t.color.text, "font-size": body.fontSize, "line-height": body.lineHeight })}">
          ${bulletHtml}
        </div>
      </div>
    `;
  }).join(`<div style="height:${t.spacing.md};"></div>`);

  return `
    <div style="${css({ padding: t.components.card.padding, border: t.components.card.border, "border-radius": t.components.card.radius, background: t.components.card.bg })}">
      ${rows}
    </div>
  `;
}


// v0.2.2-10: projects_cards
function renderProjectsCards(doc, t) {
  const pj = doc?.projects;
  const items = Array.isArray(pj) ? pj : [];
  const body = t.typography.body;
  const small = t.typography.small;

  if (!items.length) {
    return renderPlaceholder("（暂无项目经历：建议至少补充 1 个项目）", t);
  }

  const cards = items.slice(0, 4).map((it) => {
    const name = esc(it?.name || "");
    const tagline = esc(it?.tagline || "");
    const stack = Array.isArray(it?.stack) ? it.stack : [];
    const bullets = Array.isArray(it?.bullets) ? it.bullets : [];

    const stackHtml = stack.length
      ? `<div style="${css({ margin:"6px 0 0 0" })}">
           ${stack.slice(0, 8).map(s2 =>
             `<span style="${css({ display:"inline-block", margin:"6px 8px 0 0", padding:t.components.chip.padding, border:t.components.chip.border, "border-radius":t.components.chip.radius, "font-size":small.fontSize, color:t.color.text })}">${esc(s2)}</span>`
           ).join("")}
         </div>`
      : "";

    const bulletHtml = bullets.length
      ? `<ul style="${css({ margin:"8px 0 0 0", padding:"0 0 0 18px" })}">
           ${bullets.slice(0, 3).map(b => `<li style="${css({ margin:"0 0 "+t.spacing.xs+" 0" })}">${esc(b?.text ?? b)}</li>`).join("")}
         </ul>`
      : `<div style="${css({ margin:"8px 0 0 0", color:t.color.faint, "font-size":small.fontSize })}">（建议补充 2-3 条要点，突出目标/动作/结果）</div>`;

    return `
      <div style="${css({ padding:t.components.card.padding, border:t.components.card.border, "border-radius":t.components.card.radius, background:t.components.card.bg })}">
        <div style="${css({ display:"flex", "justify-content":"space-between", gap:t.spacing.sm, "align-items":"baseline", "flex-wrap":"wrap" })}">
          <div style="${css({ color:t.color.text, "font-size":body.fontSize, "font-weight":"800" })}">${name || "（项目）"}</div>
          <div style="${css({ color:t.color.subText, "font-size":small.fontSize })}">${tagline}</div>
        </div>
        ${stackHtml}
        <div style="${css({ color:t.color.text, "font-size":body.fontSize, "line-height":body.lineHeight })}">
          ${bulletHtml}
        </div>
      </div>
    `;
  }).join(`<div style="height:${t.spacing.md};"></div>`);

  return `<div style="${css({ display:"grid", gap:t.layout.blockGap })}">${cards}</div>`;
}


// v0.2.2-11: education_rows
function renderEducationRows(doc, t) {
  const edu = doc?.education;
  const items = Array.isArray(edu) ? edu : [];
  const body = t.typography.body;
  const small = t.typography.small;

  if (!items.length) {
    return renderPlaceholder("（暂无教育背景：可补充学校/专业/学历）", t);
  }

  const rows = items.slice(0, 2).map((it) => {
    const school = esc(it?.school || "");
    const major = esc(it?.major || "");
    const degree = esc(it?.degree || "");
    const extra = esc(it?.extra || "");

    const right = [degree, extra].filter(Boolean).join(" · ");

    return `
      <div style="${css({ display:"flex", "justify-content":"space-between", gap:t.spacing.sm, "align-items":"baseline", "flex-wrap":"wrap" })}">
        <div style="${css({ color:t.color.text, "font-size":body.fontSize, "font-weight":"800" })}">
          ${school || "（学校）"}
          ${major ? `<span style="${css({ color:t.color.subText, "font-weight":"600", margin:"0 0 0 8px" })}">${major}</span>` : ""}
        </div>
        <div style="${css({ color:t.color.subText, "font-size":small.fontSize })}">${right}</div>
      </div>
    `;
  }).join(`<div style="height:${t.spacing.xs};"></div>`);

  return `
    <div style="${css({ padding: t.components.card.padding, border: t.components.card.border, "border-radius": t.components.card.radius, background: t.components.card.bg })}">
      ${rows}
    </div>
  `;
}

function renderPlaceholder(text, t) {
  return `
    <div style="${css({ padding:t.spacing.sm+" "+t.spacing.md, border:t.shape.borderDash, "border-radius":t.shape.radiusCard, color:t.color.subText, "font-size":t.typography.small.fontSize })}">
      ${esc(text)}
    </div>
  `;
}

/**
 * renderResumeHtml_v0_2_2
 * - 输出一个“预览容器 + 内容”的 HTML 字符串
 * - 页面可直接 innerHTML = renderResumeHtml...
 */
export function renderResumeHtml_v0_2_2(resumeDoc, theme, outputSpec) {
  const t = theme;
  const wrapStyle = css({
    width: t.page.width,
    "max-width": t.page.maxWidth,
    padding: t.page.padding,
    margin: "0 auto",
    background: t.color.bg,
    color: t.color.text,
    "box-sizing": "border-box",
  });

  // v0.2.2-08: spec-driven rendering
  const specSections = outputSpec?.sections;
  const useSpec = Array.isArray(specSections) && specSections.length > 0;

  // fallback（旧逻辑，向后兼容）
const sections = [
    { id: "header", title: "Header", html: renderHeader(resumeDoc, t) },
    { id: "summary", title: "Summary", html: renderSummary(resumeDoc, t) },
    { id: "skills", title: "Skills", html: renderSkills(resumeDoc, t) },
    { id: "experience", title: "Experience", html: renderPlaceholder("Experience（下一步实现时间线）", t) },
    { id: "projects", title: "Projects", html: renderPlaceholder("Projects（下一步实现项目卡片）", t) },
    { id: "education", title: "Education", html: renderPlaceholder("Education（下一步实现教育列表）", t) },
  ];

  const sections2 = useSpec ? specSections.map(sec => {
    const id = sec?.id || "";
    const titleObj = sec?.title || {};
    const title = titleObj.zh || titleObj.en || String(id || "Section");
    const blocks = Array.isArray(sec?.blocks) ? sec.blocks : [];

    // 将 blocks 映射为 html（首批支持：header_card/summary_bullets/skills_grouped；其他占位）
    const html = blocks.map(b => {
      const t = b?.type;
      if (t === "header_card") return renderHeader(resumeDoc, theme);
      if (t === "summary_bullets") return renderSummary(resumeDoc, theme);
      if (t === "skills_grouped") return renderSkills(resumeDoc, theme);
      if (t === "experience_timeline") return renderExperienceTimeline(resumeDoc, theme);
      if (t === "projects_cards") return renderProjectsCards(resumeDoc, theme);
      if (t === "education_rows") return renderEducationRows(resumeDoc, theme);
      return renderPlaceholder(`${b?.id || ""} · ${t || ""}（待实现）`, theme);
    }).join(`<div style="height:${theme.layout.blockGap};"></div>`);

    return { id, title, html };
  }) : sections;
  const body = sections2.map(sec => {
    const title = renderSectionTitle(sec.title, sec.id, t);
    return `
      <div style="${css({ margin: t.layout.sectionGap+" 0 0 0" })}">
        ${title}
        <div style="${css({ display:"grid", gap: t.layout.blockGap })}">
          ${sec.html}
        </div>
      </div>
    `;
  }).join("");

  return `<div style="${wrapStyle}">${body}</div>`;
}
