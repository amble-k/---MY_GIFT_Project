import { loadDB } from "/core/storage/resume_db.js";

/**
 * FACT Structured Form (v0.2.3)
 * 目标：用结构化卡片录入（可增删），并同步到 window.__INPUT_PAYLOAD_V0_2_3__ 供预览消费
 */

function s(v){ return (v==null?"":String(v)).trim(); }

function el(tag, attrs={}, html=""){
  const n = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs||{})){
    if (k==="class") n.className = v;
    else if (k==="style") n.setAttribute("style", v);
    else n.setAttribute(k, v);
  }
  if (html) n.innerHTML = html;
  return n;
}

function textareaBulletsToArr(txt){
  const t = s(txt);
  if (!t) return [];
  return t.split(/\n/g).map(x=>x.trim()).filter(Boolean);
}

function arrToTextareaBullets(arr){
  return Array.isArray(arr) ? arr.filter(Boolean).join("\n") : "";
}

function cardShell(title){
  const box = el("div", { style: "border:1px solid #e9e9e9;border-radius:16px;background:#fff;padding:12px;margin:10px 0;" });
  const head = el("div", { style: "display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;" });
  head.appendChild(el("div", { style:"font-weight:800;font-size:13px;" }, title));
  box.appendChild(head);
  return { box, head };
}

function inputRow(label, inputEl){
  const row = el("div", { style:"display:grid;grid-template-columns:110px 1fr;gap:10px;align-items:center;margin:8px 0;" });
  row.appendChild(el("div", { style:"font-size:12px;color:rgba(0,0,0,.70);" }, label));
  row.appendChild(inputEl);
  return row;
}

function uiInput(ph=""){
  return el("input", { style:"width:100%;padding:8px;box-sizing:border-box;border:1px solid #ddd;border-radius:12px;", placeholder: ph });
}
function uiSelect(opts){
  const sel = el("select", { style:"width:100%;padding:8px;box-sizing:border-box;border:1px solid #ddd;border-radius:12px;background:#fff;" });
  (opts||[]).forEach(o=>{
    const op = el("option", {});
    op.value = o; op.textContent = o;
    sel.appendChild(op);
  });
  return sel;
}
function uiTextarea(ph="", rows=3){
  return el("textarea", { style:"width:100%;padding:8px;box-sizing:border-box;border:1px solid #ddd;border-radius:12px;resize:vertical;line-height:1.6;", rows: String(rows), placeholder: ph });
}

function button(text, onClick){
  const b = el("button", { type:"button", style:"padding:8px 10px;border:1px solid #e5e5e5;border-radius:12px;background:#fff;cursor:pointer;font-size:12px;" }, text);
  b.addEventListener("click", onClick);
  return b;
}

function sectionHeader(title, hint){
  const wrap = el("div", { style:"margin:14px 0 8px;display:flex;justify-content:space-between;align-items:flex-end;" });
  wrap.appendChild(el("div", { style:"font-weight:900;font-size:14px;" }, title));
  wrap.appendChild(el("div", { style:"font-size:12px;color:rgba(0,0,0,.55);" }, hint||""));
  return wrap;
}

function buildPayloadFromState(state){
  return {
    basic: state.basic,
    skill_tags: state.skill_tags,
    impact_tags: state.impact_tags,

    experience_items: state.experience_items,
    project_items: state.project_items,
    education_items: state.education_items,

    certifications: state.certifications,
    trainings: state.trainings,
  };
}

export function mountFactStructuredForm_v0_2_3({ hostId="fact_structured_host" } = {}){
  const host = document.getElementById(hostId);
  if (!host) {
    console.warn("[FACT][STRUCT_FORM] host not found:", hostId);
    return;
  }

  // ---- state ----
  const state = {
    basic: { name:"", targetRole:"", city:"", phone:"", email:"", links:[] },
    skill_tags: [],
    impact_tags: [],

    experience_items: [],
    project_items: [],
    education_items: [],

    certifications: [],
    trainings: [],
  };

  // [v0.2.3-12] hydrate state from DB (so "保存并留在本页" 不会清空)
  async function hydrateFromDB(){
    try{
      const db = await loadDB();
      const fpId = db?.active?.fact_profile_id || null;
      const row = fpId ? (db?.fact_profiles?.[fpId] || null) : null;
      const payload = row?.payload || row || null;
      if (!payload) return;

      // 基本信息
      state.basic = payload.basic || state.basic;
      state.skill_tags = Array.isArray(payload.skill_tags) ? payload.skill_tags : (state.skill_tags || []);
      state.impact_tags = Array.isArray(payload.impact_tags) ? payload.impact_tags : (state.impact_tags || []);

      // 列表段（没有就给空数组）
      state.experience_items = Array.isArray(payload.experience_items) ? payload.experience_items : (state.experience_items || []);
      state.project_items    = Array.isArray(payload.project_items) ? payload.project_items : (state.project_items || []);
      state.education_items  = Array.isArray(payload.education_items) ? payload.education_items : (state.education_items || []);
      state.certifications   = Array.isArray(payload.certifications) ? payload.certifications : (state.certifications || []);
      state.trainings        = Array.isArray(payload.trainings) ? payload.trainings : (state.trainings || []);

      // 保底至少一条，避免 UI 空白
      if (state.experience_items.length===0) state.experience_items.push({ period_text:"", company:"", title:"", responsibility_bullets:[], achievement_bullets:[] });
      if (state.project_items.length===0) state.project_items.push({ period_text:"", role_in_project:"参与", name:"", work_bullets:[], achievement_bullets:[], summary:"", stack_tags:[], link:null, type_tag:"" });
      if (state.trainings.length===0) state.trainings.push({ date_or_period:"", org:"", content:"", name:"培训", outcome:null });
      if (state.certifications.length===0) state.certifications.push({ date:"", name:"", issuer:"", credential_url:null });

      // 回填到顶部基础输入框（列表段由 renderXXX 渲染时回填）
      dom.name.value   = state.basic?.name || "";
      dom.target.value = state.basic?.targetRole || "";
      dom.city.value   = state.basic?.city || "";
      dom.phone.value  = state.basic?.phone || "";
      dom.email.value  = state.basic?.email || "";
      dom.skills.value = Array.isArray(state.skill_tags) ? state.skill_tags.join(", ") : "";

    }catch(e){
      console.warn("[FACT][STRUCT_FORM] hydrateFromDB failed", e);
    }
  }


  // 初始给一条空记录（更符合填写体验）
  if (state.experience_items.length===0) state.experience_items.push({ period_text:"", company:"", title:"", responsibility_bullets:[], achievement_bullets:[] });
  if (state.project_items.length===0) state.project_items.push({ period_text:"", role_in_project:"参与", name:"", work_bullets:[], achievement_bullets:[], summary:"", stack_tags:[], link:null, type_tag:"" });
  if (state.trainings.length===0) state.trainings.push({ date_or_period:"", org:"", content:"", name:"培训", outcome:null });
  if (state.certifications.length===0) state.certifications.push({ date:"", name:"", issuer:"", credential_url:null });

  // ---- sync to window for preview & save ----
  function sync(){
    // 从 basic 输入框/技能框同步
    state.basic.name = s(dom.name.value);
    state.basic.targetRole = s(dom.target.value);
    state.basic.city = s(dom.city.value);
    state.basic.phone = s(dom.phone.value);
    state.basic.email = s(dom.email.value);

    state.skill_tags = s(dom.skills.value) ? s(dom.skills.value).split(/[,，\n]/g).map(x=>x.trim()).filter(Boolean) : [];

    const payload = buildPayloadFromState(state);

    // [v0.2.3-13] legacy mirror fields (for older next-step readers)
    // 目标：下一页即使还读旧结构，也能拿到工作/项目/教育/技能
    payload.skills = Array.isArray(payload.skill_tags) ? payload.skill_tags : [];
    payload.education = Array.isArray(payload.education_items) ? payload.education_items : [];

    payload.experience = (Array.isArray(payload.experience_items) ? payload.experience_items : []).map(it => ({
      company: it.company || "",
      title: it.title || "",
      period: it.period_text || "",
      bullets: ([]).concat(
        Array.isArray(it.responsibility_bullets) ? it.responsibility_bullets : [],
        Array.isArray(it.achievement_bullets) ? it.achievement_bullets : []
      ),
    }));

    payload.projects = (Array.isArray(payload.project_items) ? payload.project_items : []).map(it => ({
      name: it.name || "",
      role: it.role_in_project || "",
      period: it.period_text || "",
      desc: it.summary || "",
      bullets: ([]).concat(
        Array.isArray(it.work_bullets) ? it.work_bullets : [],
        Array.isArray(it.achievement_bullets) ? it.achievement_bullets : []
      ),
    }));

    window.__INPUT_PAYLOAD_V0_2_3__ = payload;

    // [v0.2.3-11] sync to step payload (for top buttons: 保存/下一步)
    // 约定：FACT 页保存 payload 以 v0.2.3 输入结构为主
    window.__FACT_PAYLOAD__ = payload;
    window.__STEP_PAYLOAD__ = payload;
// 触发预览刷新（预览监听 #app 的 input/change，这里手动派发）
    try{
      const evt = new Event("input", { bubbles:true });
      document.getElementById("app")?.dispatchEvent(evt);
    }catch(e){}
  }

  // ---- render helpers for list cards ----
  function renderExperience(){
    expList.innerHTML = "";
    state.experience_items.forEach((it, idx)=>{
      const { box, head } = cardShell(`工作经历 #${idx+1}`);
      const del = button("删除", ()=>{
        if (state.experience_items.length<=1) return;
        state.experience_items.splice(idx,1); render(); sync();
      });
      head.appendChild(del);

      const period = uiInput("如：2022-06 ~ 2025-12");
      period.value = it.period_text || "";
      period.addEventListener("input", ()=>{ it.period_text=s(period.value); sync(); });

      const company = uiInput("公司");
      company.value = it.company || "";
      company.addEventListener("input", ()=>{ it.company=s(company.value); sync(); });

      const title = uiInput("职位");
      title.value = it.title || "";
      title.addEventListener("input", ()=>{ it.title=s(title.value); sync(); });

      const resp = uiTextarea("主要工作内容（每行一条，2-3条）", 4);
      resp.value = arrToTextareaBullets(it.responsibility_bullets);
      resp.addEventListener("input", ()=>{ it.responsibility_bullets=textareaBulletsToArr(resp.value); sync(); });

      const achv = uiTextarea("成果/业绩（每行一条，1-3条，尽量量化）", 4);
      achv.value = arrToTextareaBullets(it.achievement_bullets);
      achv.addEventListener("input", ()=>{ it.achievement_bullets=textareaBulletsToArr(achv.value); sync(); });

      box.appendChild(inputRow("起止时间", period));
      box.appendChild(inputRow("公司", company));
      box.appendChild(inputRow("职位", title));
      box.appendChild(inputRow("职责", resp));
      box.appendChild(inputRow("成果", achv));
      expList.appendChild(box);
    });
  }

  function renderProjects(){
    pjList.innerHTML = "";
    state.project_items.forEach((it, idx)=>{
      const { box, head } = cardShell(`项目经历 #${idx+1}`);
      const del = button("删除", ()=>{
        if (state.project_items.length<=1) return;
        state.project_items.splice(idx,1); render(); sync();
      });
      head.appendChild(del);

      const period = uiInput("如：2024-01 ~ 2024-06");
      period.value = it.period_text || "";
      period.addEventListener("input", ()=>{ it.period_text=s(period.value); sync(); });

      const role = uiSelect(["主导","参与"]);
      role.value = it.role_in_project || "参与";
      role.addEventListener("change", ()=>{ it.role_in_project=s(role.value); sync(); });

      const name = uiInput("项目名称");
      name.value = it.name || "";
      name.addEventListener("input", ()=>{ it.name=s(name.value); sync(); });

      const work = uiTextarea("项目职责/工作（每行一条，2-3条）", 4);
      work.value = arrToTextareaBullets(it.work_bullets);
      work.addEventListener("input", ()=>{ it.work_bullets=textareaBulletsToArr(work.value); sync(); });

      const achv = uiTextarea("项目成果（每行一条，1-3条，尽量量化）", 4);
      achv.value = arrToTextareaBullets(it.achievement_bullets);
      achv.addEventListener("input", ()=>{ it.achievement_bullets=textareaBulletsToArr(achv.value); sync(); });

      box.appendChild(inputRow("起止时间", period));
      box.appendChild(inputRow("角色", role));
      box.appendChild(inputRow("项目名", name));
      box.appendChild(inputRow("职责", work));
      box.appendChild(inputRow("成果", achv));
      pjList.appendChild(box);
    });
  }

  function renderCerts(){
    certList.innerHTML = "";
    state.certifications.forEach((it, idx)=>{
      const { box, head } = cardShell(`证书 #${idx+1}`);
      const del = button("删除", ()=>{
        if (state.certifications.length<=1) return;
        state.certifications.splice(idx,1); render(); sync();
      });
      head.appendChild(del);

      const date = uiInput("如：2024 / 2024-06");
      date.value = it.date || "";
      date.addEventListener("input", ()=>{ it.date=s(date.value); sync(); });

      const name = uiInput("证书名称");
      name.value = it.name || "";
      name.addEventListener("input", ()=>{ it.name=s(name.value); sync(); });

      const issuer = uiInput("颁发机构");
      issuer.value = it.issuer || "";
      issuer.addEventListener("input", ()=>{ it.issuer=s(issuer.value); sync(); });

      box.appendChild(inputRow("时间", date));
      box.appendChild(inputRow("证书名", name));
      box.appendChild(inputRow("机构", issuer));
      certList.appendChild(box);
    });
  }

  function renderTrainings(){
    trList.innerHTML = "";
    state.trainings.forEach((it, idx)=>{
      const { box, head } = cardShell(`培训 #${idx+1}`);
      const del = button("删除", ()=>{
        if (state.trainings.length<=1) return;
        state.trainings.splice(idx,1); render(); sync();
      });
      head.appendChild(del);

      const when = uiInput("如：2023-08 / 2023 Q4");
      when.value = it.date_or_period || "";
      when.addEventListener("input", ()=>{ it.date_or_period=s(when.value); sync(); });

      const org = uiInput("培训机构");
      org.value = it.org || "";
      org.addEventListener("input", ()=>{ it.org=s(org.value); sync(); });

      const content = uiTextarea("培训内容（建议写：学了什么/解决什么）", 3);
      content.value = it.content || "";
      content.addEventListener("input", ()=>{ it.content=s(content.value); sync(); });

      box.appendChild(inputRow("时间", when));
      box.appendChild(inputRow("机构", org));
      box.appendChild(inputRow("内容", content));
      trList.appendChild(box);
    });
  }

  // ---- top basic block ----
  host.innerHTML = "";
  host.appendChild(sectionHeader("结构化录入（推荐）", "每段经历可增删；时间与经历一一对应"));

  const basicBox = el("div", { style:"border:1px solid #e9e9e9;border-radius:16px;background:#fff;padding:12px;" });
  const dom = {
    name: uiInput("姓名"),
    target: uiInput("目标岗位"),
    city: uiInput("城市"),
    phone: uiInput("电话"),
    email: uiInput("邮箱"),
    skills: uiTextarea("技能（逗号/换行分隔）", 2),
  };
  [dom.name,dom.target,dom.city,dom.phone,dom.email,dom.skills].forEach(x=>x.addEventListener("input", sync));

  basicBox.appendChild(inputRow("姓名", dom.name));
  basicBox.appendChild(inputRow("目标岗位", dom.target));
  basicBox.appendChild(inputRow("城市", dom.city));
  basicBox.appendChild(inputRow("电话", dom.phone));
  basicBox.appendChild(inputRow("邮箱", dom.email));
  basicBox.appendChild(inputRow("技能", dom.skills));
  host.appendChild(basicBox);

  // ---- sections lists ----
  const expHead = sectionHeader("工作经历", "一条经历=起止时间｜公司｜职位｜职责｜成果");
  const addExp = button("+ 添加工作经历", ()=>{ state.experience_items.push({ period_text:"", company:"", title:"", responsibility_bullets:[], achievement_bullets:[] }); render(); sync(); });
  expHead.appendChild(addExp);
  host.appendChild(expHead);
  const expList = el("div"); host.appendChild(expList);

  const pjHead = sectionHeader("项目经历", "一条项目=起止时间｜角色｜项目名｜职责｜成果");
  const addPj = button("+ 添加项目经历", ()=>{ state.project_items.push({ period_text:"", role_in_project:"参与", name:"", work_bullets:[], achievement_bullets:[], summary:"", stack_tags:[], link:null, type_tag:"" }); render(); sync(); });
  pjHead.appendChild(addPj);
  host.appendChild(pjHead);
  const pjList = el("div"); host.appendChild(pjList);

  const certHead = sectionHeader("证书", "一条证书=时间｜证书名｜机构");
  const addCert = button("+ 添加证书", ()=>{ state.certifications.push({ date:"", name:"", issuer:"", credential_url:null }); render(); sync(); });
  certHead.appendChild(addCert);
  host.appendChild(certHead);
  const certList = el("div"); host.appendChild(certList);

  const trHead = sectionHeader("培训经历", "一条培训=时间｜机构｜内容");
  const addTr = button("+ 添加培训", ()=>{ state.trainings.push({ date_or_period:"", org:"", content:"", name:"培训", outcome:null }); render(); sync(); });
  trHead.appendChild(addTr);
  host.appendChild(trHead);
  const trList = el("div"); host.appendChild(trList);

  function render(){
    renderExperience();
    renderProjects();
    renderCerts();
    renderTrainings();
  }

  (async ()=>{
    await hydrateFromDB();
    render();
    sync();
    console.log("[FACT][STRUCT_FORM_V0_2_3] mounted");
  })();
}
