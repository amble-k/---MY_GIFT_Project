/**
 * FACT Preview (v0.2.3)
 * DOM -> InputPayload@0.2.3 -> mapping_rules.v0_2_3 -> ResumeDoc -> output_spec.v0_2_3 -> renderer
 */

import { mapInputToResumeDoc_v0_2_3 } from "/apps/resume_product/contracts/mapping_rules.v0_2_3.js";
import { OUTPUT_SPEC_PRO_CLEAN_V0_2_3 } from "/apps/resume_product/contracts/output_spec.professional_clean.v0_2_3.js";
import { THEME_PROFESSIONAL_CLEAN_V0_2_2 } from "/apps/resume_product/render/themes/theme_professional_clean.v0_2_2.js";
import { renderResumeHtml_v0_2_2 } from "/apps/resume_product/render/renderer_core.v0_2_2.js";

function s(v){ return (v==null?"":String(v)).trim(); }
function v(id){ return s(document.getElementById(id)?.value); }
function splitLines(txt){ return s(txt) ? s(txt).split(/\n/g).map(x=>x.trim()).filter(Boolean) : []; }
function splitSkills(txt){ return s(txt) ? s(txt).split(/[,，\n]/g).map(x=>x.trim()).filter(Boolean) : []; }

// v0.2.3-07: row-based parsers
function splitCols(line){
  // 支持：|  或  tab 作为分隔
  const raw = String(line||"").trim();
  if (!raw) return [];
  const cols = raw.split(/\s*\|\s*|\t+/g).map(x=>x.trim());
  return cols.filter(Boolean);
}

function parseRoleAndName(col2){
  // col2: "主导 增长实验平台" / "参与 增长实验平台" / "增长实验平台"
  const t = s(col2);
  if (!t) return { role:"参与", name:"" }
;
  if (t.startsWith("主导")) return { role:"主导", name: t.replace(/^主导\s*/,"").trim() }
;
  if (t.startsWith("参与")) return { role:"参与", name: t.replace(/^参与\s*/,"").trim() }
;
  return { role:"参与", name:t }
;
}

function parseCompanyAndTitle(col2){
  // col2: "某公司/产品经理" 或 "某公司-产品经理" 或 "产品经理"
  const t = s(col2);
  if (!t) return { company:"", title:"" }
;
  if (t.includes("/")) {
    const [a,b] = t.split("/",2);
    return { company:s(a), title:s(b) }
;
  }

  if (t.includes(" - ")) {
    const [a,b] = t.split(" - ",2);
    return { company:s(a), title:s(b) }
;
  }

  if (t.includes("-")) {
    const [a,b] = t.split("-",2);
    // 只在明显像“公司-职位”时拆（公司通常更长）
    if (a.length>=2 && b.length>=2) return { company:s(a), title:s(b) }
;
  }

  return { company:"", title:t }
;
}

function parseExperienceRows(txt){
  // 每行：时间 | 职位/公司职位 | 职责 | 成果
  const lines = splitLines(txt);
  const out = [];
  for (const ln of lines){
    const c = splitCols(ln);
    const period_text = c[0] || "";
    const col2 = c[1] || "";
    const { company, title }
 = parseCompanyAndTitle(col2);
    const resp = c[2] ? [c[2]] : [];
    const achv = c[3] ? [c[3]] : [];
    out.push({ company, title, period_text, responsibility_bullets: resp, achievement_bullets: achv }
);
    return out;
}

function parseProjectRows(txt){
  // 每行：时间 | 项目职位/主导参与+项目名 | 职责 | 成果
  const lines = splitLines(txt);
  const out = [];
  for (const ln of lines){
    const c = splitCols(ln);
    const period_text = c[0] || "";
    const { role, name }
 = parseRoleAndName(c[1] || "");
    const work = c[2] ? [c[2]] : [];
    const achv = c[3] ? [c[3]] : [];
    out.push({
      name,
      role_in_project: role,
      period_text,
      summary: "",          // 行录入模式下不再单独要“简述”，避免重复
      work_bullets: work,
      achievement_bullets: achv,
      stack_tags: [],
      link: null,
      type_tag: "",
    }
);
    return out;
}

function parseTrainingRows(txt){
  // 每行：时间 | 机构 | 内容
  const lines = splitLines(txt);
  const out = [];
  for (const ln of lines){
    const c = splitCols(ln);
    const date_or_period = c[0] || "";
    const org = c[1] || "";
    const content = c[2] || "";
    if (!date_or_period && !org && !content) { 
      continue;
    out.push({ name: "培训", org, date_or_period, content, outcome: null }
);
    return out;
}

function parseCertRows(txt){
  // 每行：时间 | 证书名 | 机构
  const lines = splitLines(txt);
  const out = [];
  for (const ln of lines){
    const c = splitCols(ln);
    const date = c[0] || "";
    const name = c[1] || "";
    const issuer = c[2] || "";
    if (!date && !name && !issuer) continue;;
    out.push({ name, issuer, date, credential_url: null }
);
    return out;
}


function buildInputPayload_v0_2_3(){
  // basic
  const basic = {
    name: v("fp_name"),
    targetRole: v("fp_target"),
    city: v("fp_city"),
    phone: v("fp_phone"),
    email: v("fp_email"),
    links: [],
  };

  // skills/impact（impact 暂沿用 summary 关键词推断：先留空也没关系）
  const skill_tags = splitSkills(v("fp_skills"));
  const impact_tags = []; // v0.2.3 先不强依赖（后续做多选）

  // experience (v0.2.3-07: 优先行录入 ex_rows)
  const exRowsTxt = v("ex_rows");
  const experience_items = exRowsTxt ? parseExperienceRows(exRowsTxt) : [{
    company: v("ex_company"),
    title: v("ex_title"),
    period_text: v("ex_period"),
    responsibility_bullets: splitLines(v("ex_resp")),
    achievement_bullets: splitLines(v("ex_achv")),
  }];

  // projects (v0.2.3-07: 优先行录入 pj_rows)
  const pjRowsTxt = v("pj_rows");
  const project_items = pjRowsTxt ? parseProjectRows(pjRowsTxt) : [{
    name: v("pj_name"),
    role_in_project: v("pj_role") || "参与",
    period_text: v("pj_period"),
    summary: v("pj_desc"),
    work_bullets: splitLines(v("pj_work")),
    achievement_bullets: splitLines(v("pj_achv")),
    stack_tags: [],
    link: null,
    type_tag: "",
  }];

  // education
  const education_items = [{
    school: v("ed_school"),
    major: v("ed_major"),
    degree: v("ed_degree"),
  }];

  // certifications / trainings (v0.2.3-07: 优先行录入 cert_rows / tr_rows)
  const certRowsTxt = v("cert_rows");
  const certifications = certRowsTxt ? parseCertRows(certRowsTxt) : (()=>{
    const cert_name = v("cert_name");
    return cert_name ? [{
    name: cert_name,
    issuer: v("cert_issuer"),
    date: v("cert_date"),
    credential_url: null
  }] : [];
  })();

  const trRowsTxt = v("tr_rows");
  const trainings = trRowsTxt ? parseTrainingRows(trRowsTxt) : (()=>{
    const tr_name = v("tr_name");
    return tr_name ? [{
    name: tr_name,
    org: v("tr_org"),
    date_or_period: v("tr_period"),
    content: v("tr_content"),
    outcome: null
  }] : [];
  })();

  return {
    basic,
    skill_tags,
    impact_tags,
    experience_items,
    project_items,
    education_items,
    certifications,
    trainings,
  };
}

function ensureHost(appId){
  let host = document.getElementById("resume_preview_v0_2_3_host");
  if (host) return host;

  const app = document.getElementById(appId || "app");
  host = document.createElement("div");
  host.id = "resume_preview_v0_2_3_host";
  host.style.margin = "18px auto 0";
  host.style.maxWidth = "920px";
  host.style.padding = "0 12px 24px";

  if (app && app.parentNode) app.parentNode.insertBefore(host, app.nextSibling);
  else document.body.appendChild(host);

  return host;
}

let timer = null;
function schedule(fn, ms=80){ if (timer) clearTimeout(timer); timer = setTimeout(fn, ms); }

export function enableFactPreview_v0_2_3({ appId="app", locale="zh-CN", theme="professional_clean" } = {}){
  const host = ensureHost(appId);

  function render(){
    const input = buildInputPayload_v0_2_3();
    // 给页面其它按钮/调试用
    window.__INPUT_PAYLOAD_V0_2_3__ = input;

    const doc = mapInputToResumeDoc_v0_2_3(input, { locale, theme });
    const body = renderResumeHtml_v0_2_2(doc, THEME_PROFESSIONAL_CLEAN_V0_2_2, OUTPUT_SPEC_PRO_CLEAN_V0_2_3);

    host.innerHTML = `
      <div style="margin:0 auto;max-width:920px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin:0 0 10px 0;padding:10px 12px;border:1px solid #e9e9e9;border-radius:14px;background:#fff;">
          <div style="font-weight:800;font-size:13px;">预览（Professional Clean v0.2.3）</div>
          <div style="font-size:12px;color:rgba(0,0,0,0.55);">字段已对齐：工作经历/项目经历/证书/培训</div>
        </div>
        ${body}
      </div>
    `;
  }

  console.log("[FACT][PREVIEW_MODULE_V0_2_3] enabled");
  render();

  const appEl = document.getElementById(appId);
  if (appEl){
    appEl.addEventListener("input", ()=>schedule(render), true);
    appEl.addEventListener("change", ()=>schedule(render), true);
  }
}
