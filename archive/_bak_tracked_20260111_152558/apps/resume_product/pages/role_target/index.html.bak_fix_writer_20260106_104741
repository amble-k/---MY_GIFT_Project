<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Resume Product - Role Target</title>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import { bootStepPage } from "/apps/resume_product/pages/_step_page.js?v=3";
    import { loadDB, setActive, writeFactProfileDummy } from "/core/storage/resume_db.js";

    // Step 壳：按钮会读 window.__STEP_PAYLOAD__
    bootStepPage({ title:"Resume Product — Role Target", stepId:"role_target", writeFnName:"writeFactProfileDummy" });

    const app = document.getElementById("app");

    const roles = [
      { id:"pm_product",    name:"产品经理" },
      { id:"pm_growth",     name:"增长产品经理" },
      { id:"fe_engineer",   name:"前端工程师" },
      { id:"be_engineer",   name:"后端工程师" },
      { id:"data_analyst",  name:"数据分析师" },
      { id:"ops",           name:"运营" },
    ];

    function render(selected){
      app.innerHTML = `
        <div style="max-width:920px;margin:16px auto 0;padding:0 12px;">
          <div style="border:1px solid #e9e9e9;border-radius:16px;background:#fff;padding:12px;">
            <div style="font-weight:900;font-size:14px;margin:0 0 8px 0;">目标岗位</div>
            <div style="font-size:12px;color:rgba(0,0,0,.6);margin:0 0 12px 0;">
              选择你要投递的目标岗位。下一步将基于岗位画像（AKSH）提供需要强化的表达选项。
            </div>

            <div style="display:grid;grid-template-columns:110px 1fr;gap:10px;align-items:center;margin:8px 0;">
              <div style="font-size:12px;color:rgba(0,0,0,.70);">岗位</div>
              <select id="role_id" style="width:100%;padding:8px;box-sizing:border-box;border:1px solid #ddd;border-radius:12px;background:#fff;">
                ${roles.map(r=>`<option value="${r.id}" ${r.id===selected?"selected":""}>${r.name}</option>`).join("")}
              </select>
            </div>

            <div style="display:grid;grid-template-columns:110px 1fr;gap:10px;align-items:center;margin:8px 0;">
              <div style="font-size:12px;color:rgba(0,0,0,.70);">说明</div>
              <input id="role_note" placeholder="可选：如 投递A公司/偏增长/偏B端" style="width:100%;padding:8px;box-sizing:border-box;border:1px solid #ddd;border-radius:12px;"/>
            </div>
          </div>
        </div>
      `;

      const sync = ()=>{
        const role_id = document.getElementById("role_id")?.value || "";
        const role_note = document.getElementById("role_note")?.value || "";
        const payload = { role_id, role_note, meta:{ source:"role_target.v0.2.4-01" } };

        window.__STEP_PAYLOAD__ = payload;
        window.__ROLE_TARGET_PAYLOAD__ = payload;
      };

      app.addEventListener("input", sync, true);
      app.addEventListener("change", sync, true);
      sync();
    }

    // 回填：从 DB active.role_target_id 或 active.role_id（兼容）
    (async ()=>{
      const db = await loadDB();
      const selected = db?.active?.role_id || "pm_product";
      render(selected);

      // 自动保存：选择变更就写入 db.active.role_id（不改事实档案）
      const sel = ()=>document.getElementById("role_id")?.value || "";
      app.addEventListener("change", async ()=>{
        try{
          await setActive({ role_id: sel() });
        }catch(e){}
      }, true);
    })();

  </script>
</body>
</html>
