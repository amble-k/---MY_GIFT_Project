<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Resume Product - Plan 90D</title>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import { bootStepPage } from "/apps/resume_product/pages/_step_page.js?v=3";
    import { loadDB, setActive } from "/core/storage/resume_db.js";
    import { mountStepForm } from "/core/ui/step_form_v0_2.js?v=2";

    bootStepPage({ title:"Resume Product — Plan 90D", stepId:"plan_90d", writeFnName:"writePlan90DDummy" });

    mountStepForm({
      title: "90天计划（最小版）",
      desc: "说明：输入后将自动保存（不跳页）。进入下一步仍可用上方“写入/保存并进入下一步”。",
      fields: [
        { id: "p90_goal",  label: "目标（90天）", type: "textarea", rows: 4, placeholder: "90天要达成什么？", key: "goal_90d" },
        { id: "p90_plan",  label: "行动（拆解）", type: "textarea", rows: 6, placeholder: "拆成阶段/里程碑/每周节奏…", key: "plan" },
        { id: "p90_risk",  label: "风险与对策", type: "textarea", rows: 4, placeholder: "可能的阻碍与应对…", key: "risk" },
      ],
      loadDB,
      setActive,
      writerName: "writePlan90DDummy",
      setActiveMap: { plan_90d_id: "RET_ID" },

      // 回填：plan_90d / plan_90ds 两种表名都兼容
      fillFromDB: (db) => {
        const pid =
          db?.active?.plan_90d_id ||
          db?.sessions?.[db?.active?.session_id]?.plan_90d_id ||
          null;

        const row =
          (pid && db?.plan_90d?.[pid]) ? db.plan_90d[pid] :
          (pid && db?.plan_90ds?.[pid]) ? db.plan_90ds[pid] :
          null;

        const p = row?.payload || row || {};
        return {
          goal_90d: p?.goal_90d || "",
          plan: p?.plan || "",
          risk: p?.risk || "",
        };
      },
    });
  </script>
</body>
</html>