<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Resume Product - Fact</title>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import { bootStepPage } from "/apps/resume_product/pages/_step_page.js?v=20260109_1619";
    import { mountStepForm } from "/core/ui/step_form_v0_2.js?v=2";
    import { loadDB, saveDB, setActive } from "/core/storage/resume_db.js";
    import { makeEmptyFactV03, normalizeFactV03, validateFactV03 } from "/apps/resume_product/contracts/fact_runtime.v0_3_0.js?v=20260109_1619";

    const LOCALE = "zh-CN";

    // 顶部壳：按钮逻辑在 _step_page.js（写入/保存、下一步、回入口、清空）
    bootStepPage({ title:"Resume Product — Fact", stepId:"fact", writeFnName:"writeFactProfileDummy" });

    const toLines = (s) => String(s || "")
      .split(/\n+/)
      .map(x => x.trim())
      .filter(Boolean);

    const toSkillItems = (s) => {
      const arr = String(s || "")
        .split(/[,，\n]/)
        .map(x => x.trim())
        .filter(Boolean);
      // 先都归为 tool，后续 L2/L3 再分类
      return arr.map(name => ({ name, category: "tool" }));
    };

    const toIntOrNull = (s) => {
      const n = parseInt(String(s || "").trim(), 10);
      return Number.isFinite(n) ? n : null;
    };

    mountStepForm({
      
    // ✅ required by step_form_v0_2: must be functions
    loadDB: (db) => loadDB(),
    saveDB: (db) => saveDB(db),
    setActive: (db, patch) => setActive(db, patch),

appId: "app",
      title: "事实信息（日本履歴書优先）",
      desc: "这里只录入事实。分类、融合、模板输出与生成逻辑在后台完成（前台不预览）。",

      // ✅ 录入字段（中文 + 日语括注）
      fields: [
        // --- 基本（履歴書）---
        { id: "p_name", label: "姓名（氏名）", type: "input", placeholder: "例：山田 太郎 / 王小明" },
        { id: "p_name_kana", label: "姓名读音（ふりがな）", type: "input", placeholder: "例：やまだ たろう" },
        { id: "p_birth_date", label: "出生年月日（生年月日）", type: "input", placeholder: "例：1995-04-12" },

        // 联系方式：email/phone 至少其一（由规则校验）
        { id: "p_email", label: "邮箱（メール）", type: "input", placeholder: "例：xxx@xx.com" },
        { id: "p_phone_mobile", label: "手机（携帯）", type: "input", placeholder: "例：090-1234-5678" },
        { id: "p_phone", label: "电话（固定/其他）", type: "input", placeholder: "可选" },
        { id: "p_line", label: "LINE（任意）", type: "input", placeholder: "可选" },

        // 地址（日本）
        { id: "addr_prefecture", label: "都道府県", type: "input", placeholder: "例：東京都" },
        { id: "addr_city_ward", label: "市区町村（区/町/村）", type: "input", placeholder: "例：渋谷区" },
        { id: "addr_address", label: "番地・建物名", type: "input", placeholder: "例：神南1-19-11 …" },

        // 通勤（可选）
        { id: "commute_station", label: "最寄駅", type: "input", placeholder: "例：渋谷駅" },
        { id: "commute_minutes", label: "通勤时间（分）", type: "input", placeholder: "例：35" },

        // 希望（本人希望記入欄）
        { id: "pref_job_type", label: "希望职种（希望職種）", type: "input", placeholder: "例：バックエンドエンジニア" },
        { id: "pref_work_location", label: "希望勤務地", type: "input", placeholder: "例：東京 / リモート可" },
        { id: "pref_start_date", label: "入社可能时期", type: "input", placeholder: "例：2026-02 入社可" },
        { id: "pref_salary_note", label: "希望年収（备注）", type: "input", placeholder: "例：貴社規定に従います（可选）" },

        // 签证（在日外国人常用，可选）
        { id: "visa_status", label: "在留資格/签证状态（可选）", type: "input", placeholder: "例：技術・人文知識・国際業務" },
        { id: "visa_expiry", label: "在留期限（可选）", type: "input", placeholder: "例：2027-03-31" },

        // 摘要（可选：事实版原话，后续再由 L2/L3 改写）
        { id: "p_summary", label: "自我简介（原话即可）", type: "textarea", rows: 4, placeholder: "例：3年后端经验，擅长…（先写事实，不用像简历成稿）" },

        // 技能（事实名词）
        { id: "skills_text", label: "技能（逗号/换行分隔）", type: "textarea", rows: 3, placeholder: "例：Java, Spring, AWS, SQL, Docker" },

        // 教育（最小）
        { id: "edu_school", label: "学校（学歴）", type: "input", placeholder: "例：早稲田大学" },
        { id: "edu_degree", label: "学历/学位", type: "input", placeholder: "例：学士 / 修士 / 博士" },
        { id: "edu_major", label: "专业", type: "input", placeholder: "例：情報工学" },
        { id: "edu_start", label: "入学年月", type: "input", placeholder: "例：2019-04" },
        { id: "edu_end", label: "卒業年月", type: "input", placeholder: "例：2023-03" },

        // 工作经历（最小必须：公司/岗位/开始时间 + 要点≥2）
        { id: "exp_company", label: "工作经历｜公司", type: "input", placeholder: "例：株式会社XXX" },
        { id: "exp_role", label: "工作经历｜岗位", type: "input", placeholder: "例：ソフトウェアエンジニア" },
        { id: "exp_start", label: "工作经历｜开始时间", type: "input", placeholder: "例：2022-04" },
        { id: "exp_end", label: "工作经历｜结束时间（空=至今）", type: "input", placeholder: "例：2025-12" },

        { id: "exp_resp", label: "工作经历｜职责要点（每行一条）", type: "textarea", rows: 4, placeholder: "至少 1 条\n例：负责…\n例：推动…" },
        { id: "exp_ach", label: "工作经历｜成果要点（每行一条，尽量量化）", type: "textarea", rows: 4, placeholder: "职责+成果 合计至少 2 条\n例：响应时间降低30%\n例：DAU+20%" },
      ],

      // ✅ 关键：这里直接产出 Fact v0.3（writer 里会 validate + 保存 vr.fact）
      getPayload: () => {
        // mountStepForm 内部提供 v(id) 读值（沿用你旧页面写法）
        const v = (id) => {
          const el = document.getElementById(id);
          return el ? (el.value ?? "") : "";
        };

        const base = makeEmptyFactV03({ locale: LOCALE });

        const responsibilities = toLines(v("exp_resp"));
        const achText = toLines(v("exp_ach"));
        const achievements = achText.map(t => ({ what: t }));

        const edu = {
          school: String(v("edu_school") || "").trim(),
          degree: String(v("edu_degree") || "").trim(),
          major: String(v("edu_major") || "").trim(),
          start_date: String(v("edu_start") || "").trim(),
          end_date: String(v("edu_end") || "").trim(),
        };

        const exp = {
          id: "exp_1",
          company: { name: String(v("exp_company") || "").trim() },
          role: { title: String(v("exp_role") || "").trim() },
          start_date: String(v("exp_start") || "").trim(),
          end_date: (String(v("exp_end") || "").trim() || null),
          responsibilities,
          achievements,
        };

        const out = {
          ...base,
          locale: LOCALE,

          person: {
            ...(base.person || {}),
            name: String(v("p_name") || "").trim(),
            name_kana: String(v("p_name_kana") || "").trim(),

            birth: { ...(base.person.birth || {}), date: String(v("p_birth_date") || "").trim() },

            location: {
              ...(base.person.location || {}),
              country: "日本",
              prefecture: String(v("addr_prefecture") || "").trim(),
              city_ward: String(v("addr_city_ward") || "").trim(),
              address_line: String(v("addr_address") || "").trim(),
            },

            contact: {
              ...(base.person.contact || {}),
              email: String(v("p_email") || "").trim(),
              phone: String(v("p_phone") || "").trim(),
              phone_mobile: String(v("p_phone_mobile") || "").trim(),
              line: String(v("p_line") || "").trim(),
            },

            commute: {
              ...(base.person.commute || {}),
              nearest_station: String(v("commute_station") || "").trim(),
              time_minutes: toIntOrNull(v("commute_minutes")),
            },

            visa: {
              ...(base.person.visa || {}),
              status: String(v("visa_status") || "").trim(),
              expiry: String(v("visa_expiry") || "").trim(),
            },

            summary: String(v("p_summary") || "").trim(),
          },

          preferences: {
            job_type: String(v("pref_job_type") || "").trim(),
            work_location: String(v("pref_work_location") || "").trim(),
            start_date: String(v("pref_start_date") || "").trim(),
            salary_note: String(v("pref_salary_note") || "").trim(),
          },

          skills: {
            ...(base.skills || {}),
            taxonomy_version: "tax_v1",
            items: toSkillItems(v("skills_text")),
          },

          education: [edu].filter(x => x.school || x.degree || x.major),
          experience: [exp],
        };

        // normalize + rules validate
        const vr = validateFactV03(out);
        const fact = (vr && vr.fact) ? vr.fact : normalizeFactV03(out, { locale: LOCALE });

        // ✅ 给 _step_page.js / writer 用
        window.__FACT_PAYLOAD__ = fact;
        return fact;
      },
    });

    console.log("[FACT] mounted pure-input fact page (v0.3). active=", loadDB()?.active);
  </script>
</body>
</html>
