<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Resume Product - Scenario</title>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import { bootStepPage } from "/apps/resume_product/pages/_step_page.js?v=9999";
    import { loadDB, setActive } from "/core/storage/resume_db.js";
    import { mountStepForm } from "/core/ui/step_form_v0_2.js?v=2";

    // 通用壳（按钮会读 window.__STEP_PAYLOAD__）
    bootStepPage({ title:"Resume Product — Scenario", stepId:"scenario", writeFnName:"writeScenarioDummy" });

    // v0.2 统一表单 + 回填 + payload 同步 + 自动保存
    mountStepForm({
      appId: "app",
      title: "场景选择（最小版）",
      desc: "说明：输入后将自动保存（不跳页）。进入下一步仍可用上方“写入/保存并进入下一步”。",
      fields: [
        { id: "sc_scenario", label: "场景", type: "input",  key: "scenario", placeholder: "例如：freelance / job_change / intern ..." },
        { id: "sc_note",     label: "备注", type: "textarea", key: "note", rows: 6, placeholder: "补充说明（可选）" },
      ],
      loadDB,
      setActive,
      writerName: "writeScenarioDummy",
      setActiveMap: { scenario_id: "RET_ID", scenario_profile_id: "RET_ID" },

      // 回填：优先 active.scenario_id / active.scenario_profile_id，其次 session 上的同名字段
      fillFromDB: (db) => {
        const sid = db?.active?.session_id || null;
        const scId =
          db?.active?.scenario_id ||
          db?.active?.scenario_profile_id ||
          (sid ? (db?.sessions?.[sid]?.scenario_id || db?.sessions?.[sid]?.scenario_profile_id) : null) ||
          null;

        const row =
          (scId && db?.scenarios?.[scId]) ? db.scenarios[scId] :
          (scId && db?.scenario_profiles?.[scId]) ? db.scenario_profiles[scId] :
          null;

        const p = row?.payload || {};
        return { scenario: p.scenario || "", note: p.note || "" };
      },
    });
          // ✅ 场景下拉候选（datalist，不改 step_form）
      const input = document.getElementById("sc_scenario");
      if (input) {
        const dl = document.createElement("datalist");
        dl.id = "scenario_list";
        dl.innerHTML = `
          <option value="campus" label="校招/应届"></option>
          <option value="intern" label="实习"></option>
          <option value="job_change" label="跳槽/换工作"></option>
          <option value="career_switch" label="转岗/转行"></option>
          <option value="reentry" label="重返职场"></option>
          <option value="promotion" label="晋升/升职"></option>
          <option value="freelance" label="自由职业"></option>
          <option value="overseas" label="海外求职"></option>
        `;
        document.body.appendChild(dl);
        input.setAttribute("list", "scenario_list");
      }
  </script>
</body>
</html>